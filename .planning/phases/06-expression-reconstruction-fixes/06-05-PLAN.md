---
phase: 06-expression-reconstruction-fixes
plan: 05
type: execute
wave: 2
depends_on: [06-04]
files_modified:
  - vcdecomp/core/ir/structure/orchestrator.py
  - vcdecomp/core/ir/structure/analysis/variables.py
  - vcdecomp/core/ir/structure/analysis/flow.py
  - .planning/phases/06-expression-reconstruction-fixes/PATTERN3_FIX_RESULTS.md
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Pattern 3 (missing return values) is fixed"
    - "Int functions have synthesized return statements"
    - "Pattern 1 and/or Pattern 5 fixes applied (if feasible per DEBUG_FINDINGS.md)"
  artifacts:
    - path: "vcdecomp/core/ir/structure/orchestrator.py"
      provides: "Corrected fixes for Pattern 1 (if feasible)"
      contains: "is_orphaned_target"
    - path: "vcdecomp/core/ir/structure/analysis/variables.py"
      provides: "Corrected fixes for Pattern 5 (if feasible)"
      contains: "re.findall.*&"
    - path: "vcdecomp/core/ir/structure/analysis/flow.py"
      provides: "Pattern 3 fix: Synthesize return values for non-void functions"
      contains: "def _ensure_return_value|synthesized return value"
    - path: ".planning/phases/06-expression-reconstruction-fixes/PATTERN3_FIX_RESULTS.md"
      provides: "Before/after validation results for Pattern 3 fix"
      min_lines: 30
  key_links:
    - from: "orchestrator.py"
      to: "flow.py"
      via: "function emission"
      pattern: "emit_function|format_structured_function"
    - from: "flow.py"
      to: "return value synthesis"
      via: "control flow analysis"
      pattern: "_ensure_return_value|return 0.*synthesized"
---

<objective>
Fix Pattern 3 (missing return values) and apply corrected fixes from DEBUG_FINDINGS.md if feasible.

Purpose: Pattern 3 is MEDIUM complexity and blocks compilation - int functions ending with bare `return;` crash SCMP.exe. This is more tractable than Pattern 2 (type system refactoring). Also apply corrected Pattern 1/5 fixes based on debugging insights IF DEBUG_FINDINGS.md shows clear, actionable bugs. If diagnosis reveals architectural issues, defer Pattern 1/5 and focus on Pattern 3.

Output: Pattern 3 fix + optionally corrected Pattern 1/5 fixes (if feasible), validated by reduced errors and potential successful compilation.

**Note on Pattern 2**: Type mismatches (ERROR_BASELINE.md Pattern 2) are CRITICAL but require deep type system refactoring (stack_lifter.py + expr.py). Explicitly deferred to Phase 7 due to HIGH complexity - Phase 6 targets achievable wins (Patterns 1, 3, 5) to enable compilation.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-expression-reconstruction-fixes/06-CONTEXT.md

# Gap sources
@.planning/phases/06-expression-reconstruction-fixes/06-VERIFICATION.md
@.planning/phases/06-expression-reconstruction-fixes/ERROR_BASELINE.md
@.planning/phases/06-expression-reconstruction-fixes/FIX_RESULTS.md

# Plan 06-04 diagnosis
@.planning/phases/06-expression-reconstruction-fixes/DEBUG_FINDINGS.md
</context>

<tasks>

<task type="auto">
  <name>Apply corrected Pattern 1 fix (if feasible)</name>
  <files>vcdecomp/core/ir/structure/orchestrator.py</files>
  <action>
Read DEBUG_FINDINGS.md "Pattern 1 Diagnosis" section and check "Fix Required" recommendation.

**ONLY PROCEED if DEBUG_FINDINGS.md identifies clear, actionable bug fix.**

**If diagnosis shows**:
- "Timing issue" → Apply fix to check orphaned status at correct time
- "Code path not covered" → Add orphaned check to uncovered path
- "AttributeError generates invalid placeholder" → Improve error handling

**If diagnosis shows**:
- "Requires major refactoring" → SKIP, document as deferred
- "Architectural issue" → SKIP, document as deferred
- "Root cause unclear" → SKIP, document as needs more investigation

**Implementation steps** (only if fix is clear and simple):
1. Locate code section identified in DEBUG_FINDINGS.md
2. Implement minimal fix (add comment: `# FIX (06-05): Pattern 1 - [what was fixed]`)
3. Remove debug logging added in Plan 06-04 (keep code clean)
4. Test with test1/tt.scr to verify goto block_3 eliminated

**If SKIP**: Document in task output: "Pattern 1 fix deferred: [reason from DEBUG_FINDINGS.md]"
  </action>
  <verify>
```bash
# If fix applied, verify changes
git diff "C:\Users\flori\source\repos\VC_Scripter\vcdecomp\core\ir\structure\orchestrator.py" | grep "FIX.*06-05.*Pattern 1" || echo "Pattern 1 fix skipped or no marker added"

# Verify debug logging removed
grep -c "\[GOTO DEBUG\]" "C:\Users\flori\source\repos\VC_Scripter\vcdecomp\core\ir\structure\orchestrator.py" || echo "Debug logging removed"
```
  </verify>
  <done>
- DEBUG_FINDINGS.md Pattern 1 recommendation reviewed
- Pattern 1 fix applied OR documented as deferred with justification
- Debug logging removed from orchestrator.py
- Quick test confirms no new errors introduced (if fix applied)
  </done>
</task>

<task type="auto">
  <name>Apply corrected Pattern 5 fix (if feasible)</name>
  <files>vcdecomp/core/ir/structure/analysis/variables.py</files>
  <action>
Read DEBUG_FINDINGS.md "Pattern 5 Diagnosis" section and check "Fix Required" recommendation.

**ONLY PROCEED if DEBUG_FINDINGS.md identifies clear, actionable bug fix.**

**If diagnosis shows**:
- "Regex finds but filters variables" → Adjust skip conditions
- "Variables needed before collection" → Run extraction earlier
- "Variables in different form" → Enhance regex pattern

**If diagnosis shows**:
- "Requires pipeline restructuring" → SKIP, document as deferred
- "Architectural issue" → SKIP, document as deferred
- "Root cause unclear" → SKIP, document as needs more investigation

**Implementation steps** (only if fix is clear and simple):
1. Locate code section identified in DEBUG_FINDINGS.md
2. Implement minimal fix (add comment: `# FIX (06-05): Pattern 5 - [what was fixed]`)
3. Remove debug logging added in Plan 06-04
4. Test with test3/LEVEL.scr to verify vec/enum_pl declared

**If SKIP**: Document in task output: "Pattern 5 fix deferred: [reason from DEBUG_FINDINGS.md]"
  </action>
  <verify>
```bash
# If fix applied, verify changes
git diff "C:\Users\flori\source\repos\VC_Scripter\vcdecomp\core\ir\structure\analysis\variables.py" | grep "FIX.*06-05.*Pattern 5" || echo "Pattern 5 fix skipped or no marker added"

# Verify debug logging removed
grep -c "\[VAR DEBUG\]" "C:\Users\flori\source\repos\VC_Scripter\vcdecomp\core\ir\structure\analysis\variables.py" || echo "Debug logging removed"
```
  </verify>
  <done>
- DEBUG_FINDINGS.md Pattern 5 recommendation reviewed
- Pattern 5 fix applied OR documented as deferred with justification
- Debug logging removed from variables.py
- Quick test confirms no new errors introduced (if fix applied)
  </done>
</task>

<task type="auto">
  <name>Implement Pattern 3 fix: Synthesize return values for non-void functions</name>
  <files>vcdecomp/core/ir/structure/analysis/flow.py, vcdecomp/core/ir/structure/orchestrator.py</files>
  <action>
Implement fix for Pattern 3: Missing return values in non-void functions.

**Problem**: Functions like `int func_0050(...)` end with bare `return;` instead of `return <value>;`

**Examples from ERROR_BASELINE.md**:
- test1_tt_decompiled.c line 47: func_0050 (int) has `return;`
- test2_tdm_decompiled.c line 43: func_0010 (int) has `return;`
- test3_LEVEL_decompiled.c: Multiple functions affected

**Solution approach**:

Create helper function to ensure return values in flow.py:

```python
def _ensure_return_value(func_info, return_lines: List[str]) -> List[str]:
    """
    Ensure functions with non-void return type have return values.

    Args:
        func_info: Function metadata with return type
        return_lines: List of return statements in function

    Returns:
        Corrected return statements
    """
    # Determine return type from function signature
    return_type = func_info.get('return_type', 'int')  # Default to int if unknown

    # Check if function is void
    is_void = return_type.lower() == 'void'

    corrected_lines = []
    for line in return_lines:
        # Detect bare return (no value)
        if line.strip() == 'return;':
            if is_void:
                corrected_lines.append(line)  # Void function, bare return OK
            else:
                # Non-void function needs return value
                # Synthesize placeholder return value based on type
                if 'float' in return_type.lower() or 'double' in return_type.lower():
                    corrected_lines.append('return 0.0f;  // FIX (06-05): Synthesized return value')
                elif 'char' in return_type.lower():
                    corrected_lines.append('return 0;  // FIX (06-05): Synthesized return value')
                else:
                    # Default: int or pointer types
                    corrected_lines.append('return 0;  // FIX (06-05): Synthesized return value')
        else:
            corrected_lines.append(line)  # Has return value, keep as-is

    return corrected_lines
```

**Alternative simpler approach** (if function metadata not easily accessible):

In orchestrator.py, pattern-match return statements during emission:
```python
# During line-by-line emission
if line.strip() == 'return;':
    # Check function signature at top of current function
    if function_return_type != 'void':
        line = 'return 0;  // FIX (06-05): Synthesized return value'
```

**Constraints**:
- DO NOT change control flow logic
- DO NOT analyze reachability (too complex)
- Simple pattern matching: bare `return;` → `return 0;` in non-void functions
- Synthesized values are placeholders (0, 0.0f) - not semantically correct but compileable

**Steps**:
1. Decide on simple vs complex approach based on code inspection
2. Implement in flow.py (new function) or orchestrator.py (inline fix)
3. Add comment explaining synthesis: `# FIX (06-05): Pattern 3 - synthesized return value`
4. Test with test1/tt.scr to verify bare returns now have values
  </action>
  <verify>
```bash
# Verify Pattern 3 fix implemented
grep -n "FIX.*06-05.*Pattern 3\|synthesized return value" "C:\Users\flori\source\repos\VC_Scripter\vcdecomp\core\ir\structure\orchestrator.py" "C:\Users\flori\source\repos\VC_Scripter\vcdecomp\core\ir\structure\analysis\flow.py"

# Run single test to check bare returns fixed
cd "C:\Users\flori\source\repos\VC_Scripter"
PYTHONPATH=. python -m pytest vcdecomp/tests/test_validation.py::test_decompilation_validation[tt-turntable] -v --basetemp=.test_artifacts_pattern3 2>&1 | tee pattern3_test.txt

# Inspect decompiled output for return statements
grep "return;" .test_artifacts_pattern3/test_decompilation_validation_0/test1_tt_decompiled.c | head -10
# Should show "return 0;" instead of bare "return;"
```
  </verify>
  <done>
- Pattern 3 fix implemented (return value synthesis)
- Bare return statements in non-void functions now have synthesized values
- Single test run confirms fix applied correctly
- Code includes explanatory comments
  </done>
</task>

<task type="auto">
  <name>Run full validation and document results</name>
  <files>.planning/phases/06-expression-reconstruction-fixes/PATTERN3_FIX_RESULTS.md</files>
  <action>
Run full validation suite and document Pattern 3 fix impact:

```bash
cd "C:\Users\flori\source\repos\VC_Scripter"

# Run all validation tests
PYTHONPATH=. python -m pytest vcdecomp/tests/test_validation.py::test_decompilation_validation -v --basetemp=.test_artifacts_gap_closure 2>&1 | tee gap_closure_results.txt
```

Create PATTERN3_FIX_RESULTS.md:

## Structure

### Fixes Applied in Plan 06-05

1. **Pattern 1 correction (if applied)**
   - Issue diagnosed: [from DEBUG_FINDINGS.md]
   - Fix implemented: [code change description]
   - Files changed: [orchestrator.py]
   OR
   - Status: Deferred - [reason from DEBUG_FINDINGS.md]

2. **Pattern 5 correction (if applied)**
   - Issue diagnosed: [from DEBUG_FINDINGS.md]
   - Fix implemented: [code change description]
   - Files changed: [variables.py]
   OR
   - Status: Deferred - [reason from DEBUG_FINDINGS.md]

3. **Pattern 3 fix (NEW)**
   - Issue: Bare `return;` in int-returning functions
   - Fix implemented: Synthesize `return 0;` for non-void functions
   - Files changed: [flow.py or orchestrator.py]
   - Example: `return;` → `return 0;  // FIX: Synthesized return value`

4. **Pattern 2 status (type mismatches)**
   - Issue: ERROR_BASELINE.md Pattern 2 - CRITICAL
   - Status: **Deferred to Phase 7** (Variable Type Inference)
   - Reason: Requires deep refactoring of stack_lifter.py and expr.py type system (HIGH complexity)
   - Impact: Type mismatches may still cause compiler crashes until addressed in Phase 7
   - Justification: Phase 6 targets achievable wins (Patterns 1, 3, 5) to enable basic compilation

### Validation Results

**Before Plan 06-05** (from 06-VERIFICATION.md):
- test1/tt: CRASH (0xC0000005)
- test2/tdm: CRASH (0xC0000005)
- test3/LEVEL: CRASH (0xC0000005)
- Success rate: 0/3

**After Plan 06-05**:
- test1/tt: [PASS/FAIL/CRASH] - [error count if available]
- test2/tdm: [PASS/FAIL/CRASH] - [error count if available]
- test3/LEVEL: [PASS/FAIL/CRASH] - [error count if available]
- Success rate: X/3

### Metrics Comparison

| Metric | Before (06-03) | After (06-05) | Delta |
|--------|----------------|---------------|-------|
| Scripts compiling | 0/3 | X/3 | +X |
| Compiler crashes | 3/3 | Y/3 | -Z |
| Bare returns in int functions | ~15 | 0 | -15 |
| Total patterns addressed | 2 | 3-5 | +1-3 |

### Compilation Breakthrough Analysis

**If at least one test now compiles**:
- Which test(s): [test name]
- Error count: [from SCMP.exe .err file]
- Error types: [syntax, semantic, type]
- This enables automated error analysis (no more crashes!)

**If no tests compile but no longer crash**:
- SCMP.exe now produces .err files (parseable errors)
- Can count and categorize errors automatically
- Progress: crash → parseable errors

**If tests still crash**:
- Pattern 2 (type mismatches) likely root cause
- Pattern 3 fix insufficient alone
- Recommendation: Phase 7 must address type system before full compilation possible

### Next Steps

**Scenario A: Compilation achieved (X >= 1)**
- Phase 6 SUCCESS (partial or complete)
- Update ROADMAP.md status
- Phase 7 can begin with working baseline

**Scenario B: Errors now parseable (no crashes)**
- Significant progress - automated analysis now possible
- Plan 06-06: Address remaining patterns with error guidance
- May need Pattern 2 (type system) fix before Phase 7

**Scenario C: Still crashing**
- Pattern 2 (type mismatches) is blocker
- Requires stack_lifter.py refactoring (HIGH complexity)
- Accept partial Phase 6 completion, defer to Phase 7

## Analysis Method

1. Read gap_closure_results.txt for validation outcomes
2. Extract error counts if SCMP produces .err files
3. Compare to ERROR_BASELINE.md and 06-VERIFICATION.md
4. Calculate improvement metrics
5. Assess whether compilation threshold crossed
6. Recommend next steps based on outcomes
  </action>
  <verify>
```bash
# Verify results document created
test -f "C:\Users\flori\source\repos\VC_Scripter\.planning\phases\06-expression-reconstruction-fixes\PATTERN3_FIX_RESULTS.md"
wc -l "C:\Users\flori\source\repos\VC_Scripter\.planning\phases\06-expression-reconstruction-fixes\PATTERN3_FIX_RESULTS.md"

# Check contains metrics
grep -q "Validation Results" "C:\Users\flori\source\repos\VC_Scripter\.planning\phases\06-expression-reconstruction-fixes\PATTERN3_FIX_RESULTS.md"
grep -q "Metrics Comparison" "C:\Users\flori\source\repos\VC_Scripter\.planning\phases\06-expression-reconstruction-fixes\PATTERN3_FIX_RESULTS.md"
grep -q "Next Steps" "C:\Users\flori\source\repos\VC_Scripter\.planning\phases\06-expression-reconstruction-fixes\PATTERN3_FIX_RESULTS.md"
grep -q "Pattern 2 status" "C:\Users\flori\source\repos\VC_Scripter\.planning\phases\06-expression-reconstruction-fixes\PATTERN3_FIX_RESULTS.md"
```
  </verify>
  <done>
- Full validation suite executed
- PATTERN3_FIX_RESULTS.md created with comprehensive analysis
- Before/after metrics documented
- Pattern 2 deferral explicitly documented with justification
- Next steps recommended based on outcomes
  </done>
</task>

<task type="auto">
  <name>Commit Pattern 3 fix and gap closure results</name>
  <files>None (git operations)</files>
  <action>
Commit Pattern 3 fix and any Pattern 1/5 corrections:

```bash
cd "C:\Users\flori\source\repos\VC_Scripter"

git add vcdecomp/core/ir/structure/orchestrator.py
git add vcdecomp/core/ir/structure/analysis/flow.py
git add vcdecomp/core/ir/structure/analysis/variables.py
git add .planning/phases/06-expression-reconstruction-fixes/PATTERN3_FIX_RESULTS.md

git commit -m "$(cat <<'EOF'
fix(06-05): fix Pattern 3 (missing return values) and apply corrected fixes

Gap closure fixes:
- Pattern 3 (NEW): Synthesize return values for non-void functions
  - Bare `return;` → `return 0;` in int-returning functions
  - Eliminates ~15 undefined behavior instances
- Pattern 1: [Corrected fix description if applied, else "deferred - reason"]
- Pattern 5: [Corrected fix description if applied, else "deferred - reason"]

Pattern 2 status:
- Type mismatches (ERROR_BASELINE.md Pattern 2) DEFERRED to Phase 7
- Requires deep type system refactoring (HIGH complexity)
- Phase 6 focuses on achievable wins (Patterns 1, 3, 5)

Results:
- Compilation success: 0/3 → X/3
- [BREAKTHROUGH: parseable errors / still crashing]
- See PATTERN3_FIX_RESULTS.md for full analysis

Gap closure plan 06-05 addresses verification failures from 06-VERIFICATION.md.

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>
EOF
)"
```

Update commit message with actual results from PATTERN3_FIX_RESULTS.md.
  </action>
  <verify>
```bash
# Verify commit created
git log -1 --oneline | grep "fix(06-05)"

# Verify files in commit
git show --name-only HEAD | grep -E "flow|orchestrator|PATTERN3"
```
  </verify>
  <done>
- Pattern 3 fix and corrected fixes committed
- Commit message documents gap closure progress
- Pattern 2 deferral explicitly mentioned in commit message
- PATTERN3_FIX_RESULTS.md included with metrics
  </done>
</task>

</tasks>

<verification>
## Overall Phase Checks

After plan completion:
1. Pattern 3 fix implemented (return value synthesis)
2. Pattern 1/5 corrections applied OR explicitly deferred with justification
3. Pattern 2 explicitly documented as deferred to Phase 7
4. Full validation suite executed
5. Results documented with before/after metrics
6. Breakthrough assessed (compilation achieved or still blocked)

## Success Indicators

- Pattern 3 fix eliminates bare returns in non-void functions
- Pattern 1/5 fixes applied if feasible (or deferred with clear justification)
- Pattern 2 deferral explicitly documented
- Compilation progress measured (compiles, parseable errors, or still crashing)
- Clear next steps documented based on outcomes
</verification>

<success_criteria>
## Measurable Completion

- [ ] Pattern 3 fix implemented and tested
- [ ] Pattern 1/5 corrections applied OR documented as deferred with justification
- [ ] Pattern 2 deferral explicitly documented in PATTERN3_FIX_RESULTS.md
- [ ] Full validation suite executed with results captured
- [ ] PATTERN3_FIX_RESULTS.md created with metrics analysis
- [ ] Compilation progress assessed (success, parseable errors, or blocked)
- [ ] Fixes committed to repository

## Quality Gates

- Pattern 3 fix targets specific issue (bare returns in non-void functions)
- Fixes are minimal and focused (not refactoring)
- Before/after metrics show measurable improvement
- Pattern 2 deferral justified (HIGH complexity, needs Phase 7)
- Next steps clear based on validation outcomes
- Debug logging removed (code stays clean)
</success_criteria>

<output>
After completion, create `.planning/phases/06-expression-reconstruction-fixes/06-05-SUMMARY.md`
</output>
