---
phase: 06-expression-reconstruction-fixes
plan: 03
type: execute
wave: 3
depends_on: [06-02]
files_modified:
  - .planning/phases/06-expression-reconstruction-fixes/PHASE_COMPLETION.md
  - .planning/baselines/test_decompilation_validation_with_baseline
autonomous: true

must_haves:
  truths:
    - "All validation tests execute without crashes"
    - "Regression baseline updated to reflect fixes"
    - "Phase completion status documented with metrics"
    - "Remaining issues (if any) documented for future phases"
  artifacts:
    - path: ".planning/phases/06-expression-reconstruction-fixes/PHASE_COMPLETION.md"
      provides: "Phase 6 completion report with final metrics and remaining work"
      min_lines: 30
    - path: ".planning/baselines/test_decompilation_validation_with_baseline"
      provides: "Updated regression baseline YAML files"
      contains: "verdict:|compilation_succeeded:|error_count:"
  key_links:
    - from: "vcdecomp/tests/test_validation.py"
      to: ".planning/baselines/"
      via: "pytest-regressions data_regression.check()"
      pattern: "data_regression\\.check"
---

<objective>
Validate expression fixes, update regression baseline, and document phase completion status.

Purpose: Ensure fixes are stable and regression-tested. Update CI baseline so future changes are validated against improved state. Document what was achieved in Phase 6 and what remains for Phase 7 (variable declarations) and Phase 8 (control flow). This closes the loop on systematic improvement.

Output: Updated regression baseline, phase completion report, ready state for next phase.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-expression-reconstruction-fixes/06-CONTEXT.md
@.planning/phases/06-expression-reconstruction-fixes/06-RESEARCH.md

# Prior plan outputs
@.planning/phases/06-expression-reconstruction-fixes/ERROR_BASELINE.md
@.planning/phases/06-expression-reconstruction-fixes/FIX_RESULTS.md
</context>

<tasks>

<task type="auto">
  <name>Run full validation suite with baseline update</name>
  <files>.planning/baselines/test_decompilation_validation_with_baseline/</files>
  <action>
Run complete validation test suite including baseline regression tests:

```bash
cd C:\Users\flori\source\repos\VC_Scripter

# Run validation tests with baseline update
PYTHONPATH=. python -m pytest vcdecomp/tests/test_validation.py -v --basetemp=.test_artifacts_final --force-regen 2>&1 | tee test_output_final.txt
```

The `--force-regen` flag will regenerate baseline YAML files in `.planning/baselines/` with new metrics:
- verdict (PASS/PARTIAL/FAIL)
- compilation_succeeded (true/false)
- bytecode_identical (true/false)
- error_count (integer)
- semantic_diffs (integer)

This updates the regression baseline to reflect Phase 6 improvements, so CI will detect if future changes break what we just fixed.

## Expected Outcomes

Depending on FIX_RESULTS.md from Plan 02:

**Scenario A: All tests now pass**
- baseline YAML shows "compilation_succeeded: true" for all 3 tests
- CI will fail if future changes introduce compilation errors

**Scenario B: Some tests pass, some still fail**
- baseline YAML reflects mixed state
- Passing tests protected by regression detection
- Failing tests document current error counts

**Scenario C: No tests pass yet (errors reduced but not eliminated)**
- baseline YAML shows reduced error_count from original
- Progress is measurable
- More work needed in Phase 7/8

All scenarios are acceptable outcomes - baseline captures reality.
  </action>
  <verify>
```bash
# Verify baseline files updated
ls -la .planning/baselines/test_decompilation_validation_with_baseline/

# Check that baseline contains all 3 tests
test -f ".planning/baselines/test_decompilation_validation_with_baseline/test_decompilation_validation_with_baseline[tt-turntable].yml"
test -f ".planning/baselines/test_decompilation_validation_with_baseline/test_decompilation_validation_with_baseline[tdm-deathmatch].yml"
test -f ".planning/baselines/test_decompilation_validation_with_baseline/test_decompilation_validation_with_baseline[level-script].yml"

# Verify files contain metrics
grep "verdict:" .planning/baselines/test_decompilation_validation_with_baseline/*.yml
grep "error_count:" .planning/baselines/test_decompilation_validation_with_baseline/*.yml
```
  </verify>
  <done>
- Full test suite executed successfully
- Baseline YAML files regenerated in .planning/baselines/
- test_output_final.txt captures final validation state
- Baselines reflect post-fix metrics for regression detection
  </done>
</task>

<task type="auto">
  <name>Create phase completion report</name>
  <files>.planning/phases/06-expression-reconstruction-fixes/PHASE_COMPLETION.md</files>
  <action>
Create PHASE_COMPLETION.md documenting Phase 6 outcomes:

## Structure

1. **Phase Goal Recap**
   - Goal: Expression reconstruction produces syntactically valid C code
   - Scope: DECOMP-01 requirement (expression syntax errors)
   - Approach: Validation-driven debugging with error categorization

2. **What Was Fixed**
   List fixes from Plan 02 with:
   - Error pattern addressed
   - File and function modified
   - Impact: how many errors eliminated

   Example:
   - **Operator precedence in binary expressions** (expr.py, _format_binary)
     - Fixed missing parent_operator parameter
     - Eliminated 12 syntax errors across 3 tests

3. **Results Summary**

   | Metric | Before (Baseline) | After (Plan 02) | Final | Improvement |
   |--------|-------------------|-----------------|-------|-------------|
   | Total compilation errors | X | Y | Z | -N errors |
   | Scripts compiling | 0/3 | 1/3 | 2/3 | +2 scripts |
   | Syntax error rate | X% | Y% | Z% | -N% |

   (Fill with actual metrics from ERROR_BASELINE.md, FIX_RESULTS.md, and test_output_final.txt)

4. **Requirement Coverage**

   **DECOMP-01: Expression reconstruction produces valid C syntax**
   - Status: [COMPLETE / PARTIAL / IN_PROGRESS]
   - Evidence:
     - Compilation success rate: X/3 tests
     - Remaining syntax errors: N
     - Regression baseline updated

   Acceptance criteria:
   - [x] Decompiled expressions compile without syntax errors (or specify remaining count)
   - [x] Operator precedence correctly preserved (verified by validation)
   - [x] Type casts generated where needed (verified by compilation)
   - [x] Complex expressions render correctly (verified by test suite)
   - [x] Regression tests confirm fixes stable (baseline updated)

5. **Remaining Work**

   **For Phase 7 (Variable Declaration Fixes):**
   - Variable type inference (if errors remain)
   - Array declarations
   - Struct field access

   **For Phase 8 (Control Flow Fixes):**
   - If/else statement generation
   - Switch/case patterns
   - Loop code emission

   **Known Limitations:**
   - [List any expression patterns not fixable in current architecture]
   - [List any deferred issues due to complexity]

6. **Lessons Learned**
   - What worked well in validation-driven debugging
   - What patterns were easier/harder to fix than expected
   - Any architectural insights for future phases

## Analysis Method

1. Read ERROR_BASELINE.md for "before" state
2. Read FIX_RESULTS.md for Plan 02 changes
3. Read test_output_final.txt for final validation results
4. Calculate improvement metrics
5. Assess DECOMP-01 requirement status
6. Document next phase dependencies

Be honest about outcomes - partial progress is valuable progress.
  </action>
  <verify>
```bash
# Verify completion report exists
test -f .planning/phases/06-expression-reconstruction-fixes/PHASE_COMPLETION.md
wc -l .planning/phases/06-expression-reconstruction-fixes/PHASE_COMPLETION.md
# Should be 30+ lines

# Check contains required sections
grep -q "Phase Goal Recap" .planning/phases/06-expression-reconstruction-fixes/PHASE_COMPLETION.md
grep -q "Results Summary" .planning/phases/06-expression-reconstruction-fixes/PHASE_COMPLETION.md
grep -q "Requirement Coverage" .planning/phases/06-expression-reconstruction-fixes/PHASE_COMPLETION.md
grep -q "Remaining Work" .planning/phases/06-expression-reconstruction-fixes/PHASE_COMPLETION.md
```
  </verify>
  <done>
- PHASE_COMPLETION.md created with comprehensive analysis
- Metrics tables filled with actual before/after data
- Requirement DECOMP-01 status assessed
- Remaining work documented for Phases 7-8
  </done>
</task>

<task type="auto">
  <name>Update roadmap and commit phase artifacts</name>
  <files>.planning/ROADMAP.md</files>
  <action>
Update ROADMAP.md Phase 6 status and commit all phase artifacts:

## Update ROADMAP.md

1. Find Phase 6 section
2. Update status line:
   - If all tests pass: `**Status**: COMPLETE`
   - If tests improved but not all passing: `**Status**: PARTIAL (X/3 tests compiling, Y% error reduction)`
3. Update Plans section to mark completed plans:
   ```
   Plans:
   - [x] 06-01-PLAN.md — Baseline Error Analysis
   - [x] 06-02-PLAN.md — Fix High-Priority Expression Bugs
   - [x] 06-03-PLAN.md — Regression Validation
   ```
4. Update Progress table at bottom:
   ```
   | 6. Expression Reconstruction Fixes | 3/3 | Complete | 2026-01-XX |
   ```

## Commit artifacts

```bash
cd C:\Users\flori\source\repos\VC_Scripter

git add .planning/phases/06-expression-reconstruction-fixes/PHASE_COMPLETION.md
git add .planning/baselines/test_decompilation_validation_with_baseline/*.yml
git add .planning/ROADMAP.md

git commit -m "$(cat <<'EOF'
docs(06): complete Expression Reconstruction Fixes phase

Phase 6 Results:
- Baseline: X total compilation errors across 3 tests
- Fixed: Top N priority patterns in expr.py
- Final: Y errors remaining, Z/3 tests compiling
- Improvement: -M errors (-P%)

Deliverables:
- ERROR_BASELINE.md: Error pattern analysis
- FIX_RESULTS.md: Before/after metrics
- PHASE_COMPLETION.md: Phase outcomes and next steps
- Updated regression baselines for CI

Requirement DECOMP-01: [COMPLETE/PARTIAL with X% progress]

Next: Phase 7 - Variable Declaration Fixes

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>
EOF
)"
```

Update commit message with actual metrics from PHASE_COMPLETION.md.
  </action>
  <verify>
```bash
# Verify commit created
git log -1 --oneline | grep "docs(06)"

# Verify roadmap updated
grep "Expression Reconstruction Fixes.*Complete" .planning/ROADMAP.md || grep "Expression Reconstruction Fixes.*PARTIAL" .planning/ROADMAP.md

# Verify all artifacts committed
git show --name-only HEAD | grep "PHASE_COMPLETION.md"
git show --name-only HEAD | grep "baselines"
```
  </verify>
  <done>
- ROADMAP.md updated with Phase 6 completion status
- All phase artifacts committed to repository
- Commit message documents results with metrics
- Repository ready for Phase 7 planning
  </done>
</task>

</tasks>

<verification>
## Overall Phase Checks

After plan completion:
1. Regression baseline updated to reflect fixes
2. PHASE_COMPLETION.md documents outcomes
3. ROADMAP.md shows Phase 6 status
4. All artifacts committed to git

## Success Indicators

- Baseline YAML files contain improved metrics vs original
- Phase completion report honestly assesses progress
- No test regressions (baseline update succeeds)
- Clear handoff to Phase 7 with documented remaining work
</verification>

<success_criteria>
## Measurable Completion

- [ ] Full test suite runs with updated baseline
- [ ] Baseline YAML files regenerated in .planning/baselines/
- [ ] PHASE_COMPLETION.md created with metrics analysis
- [ ] ROADMAP.md updated with phase status
- [ ] All artifacts committed to git
- [ ] No test regressions introduced

## Quality Gates

- Baseline captures actual post-fix state (not aspirational)
- Completion report includes honest assessment of progress
- Remaining work clearly documented for next phases
- Metrics show measurable improvement from baseline (even if not 100% fixed)
</success_criteria>

<output>
After completion, create `.planning/phases/06-expression-reconstruction-fixes/06-03-SUMMARY.md`
</output>
