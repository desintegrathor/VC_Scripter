---
phase: 06-expression-reconstruction-fixes
plan: 02
type: execute
wave: 2
depends_on: [06-01]
files_modified:
  - vcdecomp/core/ir/expr.py
  - vcdecomp/core/ir/parenthesization.py
autonomous: true

must_haves:
  truths:
    - "Top-priority expression bugs are fixed"
    - "Fixed expressions compile successfully with SCMP.exe"
    - "Validation tests show reduced error count compared to baseline"
    - "No regressions introduced in previously-working code"
  artifacts:
    - path: "vcdecomp/core/ir/expr.py"
      provides: "Fixed expression formatting with corrected operator precedence, type casts, or syntax generation"
      contains: "def _format_binary|def _format_unary|def _render_value"
    - path: "vcdecomp/core/ir/parenthesization.py"
      provides: "Corrected parenthesization logic (if needed based on baseline)"
      contains: "def needs_parens"
  key_links:
    - from: "vcdecomp/core/ir/expr.py"
      to: "vcdecomp/core/ir/parenthesization.py"
      via: "needs_parens function calls"
      pattern: "needs_parens\\("
    - from: "vcdecomp/tests/test_validation.py"
      to: "vcdecomp/core/ir/expr.py"
      via: "format_structured_function_named → ExpressionFormatter"
      pattern: "format_structured_function"
---

<objective>
Fix the highest-priority expression reconstruction bugs identified in baseline analysis.

Purpose: Systematically address the top 3-5 most frequent expression errors that prevent compilation. Each fix is validated immediately by running the test suite to confirm errors decrease and no regressions occur. This is validation-driven debugging - fix one pattern, verify with SCMP.exe, iterate.

Output: Updated expr.py and/or parenthesization.py with fixes for top-priority expression bugs, verified by reduced compilation error count in validation tests.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-expression-reconstruction-fixes/06-CONTEXT.md
@.planning/phases/06-expression-reconstruction-fixes/06-RESEARCH.md

# Baseline from Plan 01
@.planning/phases/06-expression-reconstruction-fixes/ERROR_BASELINE.md

# Phase 4 infrastructure (error analysis)
@.planning/phases/04-error-analysis-system/04-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Identify and implement fixes for top-priority error patterns</name>
  <files>vcdecomp/core/ir/expr.py, vcdecomp/core/ir/parenthesization.py</files>
  <action>
Read ERROR_BASELINE.md "Fix Targets for Plan 02" section to get prioritized list.

For each top-priority pattern (typically 3-5 patterns):

## Fix Implementation Process

1. **Locate the bug**
   - Search expr.py for relevant code sections (e.g., _format_binary for operator issues, _render_value for type issues)
   - Check parenthesization.py if precedence-related
   - Use grep to find related code:
     ```bash
     grep -n "pattern_keyword" vcdecomp/core/ir/expr.py
     ```

2. **Understand current behavior**
   - Read the buggy code section
   - Check if there's existing logic that's broken or missing logic entirely
   - Look for FIX comments indicating known issues

3. **Implement minimal fix**
   - Make smallest change that fixes the pattern
   - Add inline comment explaining fix: `# FIX: [Pattern name from baseline] - [what was wrong]`
   - Preserve existing code structure - this is bug fixing, not refactoring

4. **Verify fix immediately**
   Run single test to check if error count decreases:
   ```bash
   PYTHONPATH=. python -m pytest vcdecomp/tests/test_validation.py::test_decompilation_validation[tt-turntable] -v --basetemp=.test_artifacts_fix
   ```

   Compare error count to baseline:
   - Baseline: X errors
   - After fix: Y errors
   - Expected: Y < X (errors decreased)

5. **Iterate until top patterns fixed**
   Repeat for next priority pattern.

## Common Fix Patterns (based on RESEARCH.md)

**Pattern: Incorrect operator precedence**
- Location: _format_binary, _render_value
- Fix: Ensure parent_operator is passed correctly to needs_parens()
- Example:
  ```python
  # BEFORE (missing parent_operator)
  left_expr = self._render_value(lhs)

  # AFTER (fixed)
  left_expr = self._render_value(lhs, parent_operator=operator)
  ```

**Pattern: Missing type casts**
- Location: _render_value, _format_cast
- Fix: Check expected_type_str and emit explicit cast
- Example:
  ```python
  # BEFORE (missing cast)
  return str(value)

  # AFTER (fixed)
  if expected_type_str and 'float' in expected_type_str:
      return f"(float){value}"
  ```

**Pattern: Incorrect float literal formatting**
- Location: _is_likely_float, _format_float
- Fix: Ensure .0f suffix for float literals
- Example:
  ```python
  # BEFORE (missing suffix)
  return f"{f:.4f}"

  # AFTER (fixed)
  return f"{f:.4f}f"
  ```

**Pattern: Over/under parenthesization**
- Location: parenthesization.py needs_parens()
- Fix: Correct precedence table or associativity logic
- Check OPERATOR_PRECEDENCE table matches C standard

## Important Constraints

- DO NOT refactor working code
- DO NOT change variable names or code structure
- DO NOT "improve" code that isn't causing errors
- Focus ONLY on fixing patterns identified in baseline
- Each fix must reduce error count when validated

## If stuck

If a pattern is unclear or fix attempt doesn't reduce errors:
1. Check decompiled .c file in .test_artifacts_fix/
2. Compare to original .c file in decompiler_source_tests/
3. Look for difference in expression formatting
4. Add debug print() in expr.py to trace execution
5. Document in SUMMARY if pattern needs deeper investigation
  </action>
  <verify>
```bash
# Run full test suite and capture error counts
PYTHONPATH=. python -m pytest vcdecomp/tests/test_validation.py::test_decompilation_validation -v --basetemp=.test_artifacts_fixed 2>&1 | tee test_output_fixed.txt

# Compare error counts to baseline
# Baseline error counts in ERROR_BASELINE.md
# Fixed error counts in test_output_fixed.txt

# Verification checks:
# 1. Total errors decreased from baseline
# 2. At least one test now compiles (if none compiled in baseline)
# 3. No new error types introduced
```
  </verify>
  <done>
- Top 3-5 priority patterns from baseline addressed with code fixes
- Each fix includes inline comment explaining what was corrected
- Validation test suite shows reduced error count
- Test output captured in test_output_fixed.txt for comparison
  </done>
</task>

<task type="auto">
  <name>Run regression validation and document results</name>
  <files>.planning/phases/06-expression-reconstruction-fixes/FIX_RESULTS.md</files>
  <action>
Create FIX_RESULTS.md documenting the impact of fixes:

## Structure

1. **Fixes Applied**
   List each fix with:
   - Pattern addressed
   - File and line numbers changed
   - Brief explanation of what was corrected
   - Example: before/after code snippet

2. **Validation Results**
   For each test script:
   - Baseline error count: X
   - After fixes error count: Y
   - Delta: Y - X (should be negative)
   - Compilation status: PASS/FAIL
   - Top remaining errors (if still failing)

3. **Metrics Comparison**

   | Metric | Baseline | After Fixes | Delta |
   |--------|----------|-------------|-------|
   | Total compilation errors | X | Y | Y-X |
   | Scripts compiling | A/3 | B/3 | +C |
   | Syntax errors | X1 | Y1 | Y1-X1 |
   | Type errors | X2 | Y2 | Y2-X2 |

4. **Regression Check**
   - Were any new errors introduced? (check for error types not in baseline)
   - Did any previously-passing validations fail?
   - If regressions found: document and plan mitigation

5. **Next Steps**
   - If all tests now PASS → Phase 6 complete, ready for Phase 7
   - If tests still FAIL → document remaining error patterns for potential Plan 03
   - If regressions found → may need rollback and alternative fix approach

## Analysis Method

Compare test_output_fixed.txt to baseline pytest output:
1. Extract error counts for each test
2. Calculate deltas
3. Check if any errors disappeared completely (category went from N to 0)
4. Identify any new error categories (present in fixed but not baseline)

Include code snippets showing before/after for significant fixes.
  </action>
  <verify>
```bash
# Verify results document exists
test -f .planning/phases/06-expression-reconstruction-fixes/FIX_RESULTS.md
wc -l .planning/phases/06-expression-reconstruction-fixes/FIX_RESULTS.md

# Check contains metrics comparison
grep -q "Metrics Comparison" .planning/phases/06-expression-reconstruction-fixes/FIX_RESULTS.md
grep -q "Validation Results" .planning/phases/06-expression-reconstruction-fixes/FIX_RESULTS.md
```
  </verify>
  <done>
- FIX_RESULTS.md created with complete before/after analysis
- Error count deltas calculated for all test scripts
- Regression check completed (no new errors introduced)
- Next steps documented based on results
  </done>
</task>

<task type="auto">
  <name>Commit expression fixes</name>
  <files>None (git operations)</files>
  <action>
Commit the expression reconstruction fixes:

```bash
cd C:\Users\flori\source\repos\VC_Scripter
git add vcdecomp/core/ir/expr.py vcdecomp/core/ir/parenthesization.py .planning/phases/06-expression-reconstruction-fixes/FIX_RESULTS.md
git commit -m "$(cat <<'EOF'
fix(06-02): fix top-priority expression reconstruction bugs

Addressed highest-frequency compilation errors identified in
baseline analysis:
- [List pattern 1: e.g., "operator precedence in binary expressions"]
- [List pattern 2: e.g., "missing float literal suffixes"]
- [List pattern 3: e.g., "type cast generation"]

Results:
- Total errors reduced from X to Y (-Z errors)
- Scripts compiling: A/3 → B/3
- Validation: [summary of test results]

See FIX_RESULTS.md for detailed before/after analysis.

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>
EOF
)"
```

Note: Update commit message with actual patterns fixed and metrics from FIX_RESULTS.md.
  </action>
  <verify>
```bash
# Verify commit created
git log -1 --oneline | grep "fix(06-02)"

# Verify files in commit
git show --name-only HEAD | grep "expr.py"
```
  </verify>
  <done>
- Expression fixes committed with detailed commit message
- FIX_RESULTS.md included in commit
- Commit message includes actual metrics from validation
  </done>
</task>

</tasks>

<verification>
## Overall Phase Checks

After plan completion:
1. expr.py and/or parenthesization.py modified with targeted fixes
2. Validation test suite shows reduced error count vs baseline
3. No regressions introduced (no new error types)
4. FIX_RESULTS.md documents impact with metrics

## Success Indicators

- At least 30% reduction in total compilation errors (X errors → 0.7X or fewer)
- At least one test script now compiles (if none compiled in baseline)
- Fixes target specific patterns, not shotgun changes
- Each fix has inline comment explaining correction
</verification>

<success_criteria>
## Measurable Completion

- [ ] Top 3-5 priority patterns from baseline addressed
- [ ] Code changes committed to expr.py and/or parenthesization.py
- [ ] Validation tests run with reduced error count
- [ ] FIX_RESULTS.md created with before/after metrics
- [ ] No regressions introduced (verified by comparison)
- [ ] Changes committed to git

## Quality Gates

- Error count decreased from baseline (delta < 0)
- Fixes are minimal and targeted (not refactoring)
- Each fix includes explanatory comment
- Validation output demonstrates improvement
</success_criteria>

<output>
After completion, create `.planning/phases/06-expression-reconstruction-fixes/06-02-SUMMARY.md`
</output>
