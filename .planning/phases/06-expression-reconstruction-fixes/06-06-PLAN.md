---
phase: 06-expression-reconstruction-fixes
plan: 06
type: execute
wave: 1
depends_on: []
files_modified:
  - vcdecomp/core/ir/structure/orchestrator.py
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "No undefined goto labels in decompiled code"
    - "All goto statements target defined labels"
    - "test1_tt_decompiled.c compiles without 'undefined label' errors"
  artifacts:
    - path: "vcdecomp/core/ir/structure/orchestrator.py"
      provides: "Orphaned block detection and label emission"
      min_lines: 800
      pattern: "orphaned.*block|emit.*label"
  key_links:
    - from: "orchestrator.py:_detect_orphaned_blocks"
      to: "orchestrator.py:_emit_goto_statement"
      via: "Orphaned check prevents goto emission"
      pattern: "if.*orphaned.*continue"
    - from: "orchestrator.py:_emit_block_label"
      to: "decompiled output"
      via: "Label emission for all goto targets"
      pattern: "block_\\d+:"
---

<objective>
Fix Pattern 1 (undefined goto labels) by investigating why orphaned block detection fails for blocks 3, 46, and 48.

Purpose: Close the final gap in Phase 6 syntax error fixes. Pattern 1 was claimed fixed but verification shows 3 undefined gotos still exist.

Output: Decompiled code with no undefined goto labels, enabling progression toward compilation success.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Gap closure context
@.planning/phases/06-expression-reconstruction-fixes/06-VERIFICATION-FINAL.md
@.planning/phases/06-expression-reconstruction-fixes/06-05-SUMMARY.md
@.planning/phases/06-expression-reconstruction-fixes/DEBUG_FINDINGS.md

# Source files
@vcdecomp/core/ir/structure/orchestrator.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Diagnostic instrumentation for Pattern 1 failure</name>
  <files>vcdecomp/core/ir/structure/orchestrator.py</files>
  <action>
Add diagnostic logging to understand why blocks 3, 46, 48 pass the orphaned check but labels are never emitted.

Instrument three critical points:

1. **At orphaned block detection (lines 763-819)** - Log the decision for blocks 3, 46, 48:
   - target_block value
   - Presence in cfg.blocks
   - Presence in func_block_ids
   - Predecessor count
   - Final orphaned decision (True/False)

2. **At label emission** - Log when labels ARE emitted:
   - Block ID receiving label
   - Reason for emission (jumped-to block, function entry, etc.)

3. **At goto emission (around line 800)** - Log goto targets:
   - Source block
   - Target block
   - Whether orphaned check skipped goto

Use [PATTERN1_DEBUG] prefix for all logging (WARNING level for pytest visibility).

DO NOT fix the bug yet - only add diagnostics to understand root cause.
  </action>
  <verify>
Run validation test and grep debug output:
```bash
cd C:/Users/flori/source/repos/VC_Scripter
PYTHONPATH=. python -m pytest vcdecomp/tests/test_validation.py::test_decompilation_validation[test1_tt] -v --log-cli-level=WARNING 2>&1 | grep PATTERN1_DEBUG > pattern1_debug_output.txt
cat pattern1_debug_output.txt
```

Output should show:
- Orphaned checks for blocks 3, 46, 48
- Label emission decisions for all blocks
- Goto emission decisions
  </verify>
  <done>
Debug output file exists showing orphaned detection and label emission decisions for blocks 3, 46, 48.
  </done>
</task>

<task type="auto">
  <name>Task 2: Root cause analysis from debug output</name>
  <files>.planning/phases/06-expression-reconstruction-fixes/PATTERN1_ROOT_CAUSE.md</files>
  <action>
Analyze the debug output from Task 1 to identify why Pattern 1 fails.

Create PATTERN1_ROOT_CAUSE.md with:

1. **Evidence section** - Copy relevant debug lines showing:
   - Orphaned check results for blocks 3, 46, 48
   - Label emission (or lack thereof) for these blocks
   - Goto emission that references these blocks

2. **Hypothesis section** - Based on evidence, determine one of:
   - A) Orphaned check logic is wrong (blocks ARE orphaned but check says no)
   - B) Labels need emission but separate code path fails to emit them
   - C) Gotos generated before orphaned check runs (timing issue)
   - D) Multiple CFG traversal passes overwrite orphaned detection

3. **Fix proposal section** - Specific code changes needed based on hypothesis

Be specific: cite line numbers, variable values, and control flow paths.
  </action>
  <verify>
```bash
cat C:/Users/flori/source/repos/VC_Scripter/.planning/phases/06-expression-reconstruction-fixes/PATTERN1_ROOT_CAUSE.md
```

File should have:
- Evidence section with actual debug output
- Clear hypothesis with reasoning
- Specific fix proposal with line numbers
  </verify>
  <done>
PATTERN1_ROOT_CAUSE.md exists with evidence-based hypothesis and fix proposal.
  </done>
</task>

<task type="auto">
  <name>Task 3: Implement targeted fix based on root cause</name>
  <files>vcdecomp/core/ir/structure/orchestrator.py</files>
  <action>
Implement the fix proposed in PATTERN1_ROOT_CAUSE.md.

Common fix patterns based on likely root causes:

**If Hypothesis A (orphaned check logic wrong):**
- Tighten orphaned detection: check if target block is in the current function's reachable blocks, not just has any predecessor
- Example: `if target_block not in reachable_from_entry(cfg, func_entry_block):`

**If Hypothesis B (label emission path missing):**
- Ensure all goto targets get labels emitted, even if block is orphaned
- Example: Track all goto targets, emit labels for them regardless of orphaned status

**If Hypothesis C (timing issue):**
- Run orphaned detection AFTER all gotos are collected, not during emission
- Example: Two-pass approach - collect gotos, detect orphaned, emit code

**If Hypothesis D (multiple passes):**
- Use a definitive orphaned check that isn't overwritten
- Example: Calculate orphaned blocks once at start, store in set

After implementing fix, remove all [PATTERN1_DEBUG] logging.
  </action>
  <verify>
Run test and check for undefined gotos:
```bash
cd C:/Users/flori/source/repos/VC_Scripter
python -m vcdecomp structure decompiler_source_tests/test1/tt.scr > test1_fixed.c
grep "goto block_3" test1_fixed.c
grep "goto block_46" test1_fixed.c
grep "goto block_48" test1_fixed.c
grep "block_3:" test1_fixed.c
grep "block_46:" test1_fixed.c
grep "block_48:" test1_fixed.c
```

Should show:
- Either gotos removed (if blocks orphaned) OR labels emitted (if blocks needed)
- No goto without corresponding label
  </verify>
  <done>
test1_fixed.c has no undefined goto labels - all gotos either removed or have matching labels.
  </done>
</task>

<task type="auto">
  <name>Task 4: Comprehensive validation across all test cases</name>
  <files>.planning/phases/06-expression-reconstruction-fixes/PATTERN1_FIX_VALIDATION.md</files>
  <action>
Run full test suite and verify Pattern 1 fix across all test cases.

1. **Decompile all test files:**
```bash
cd C:/Users/flori/source/repos/VC_Scripter
python -m vcdecomp structure decompiler_source_tests/test1/tt.scr > test1_validation.c
python -m vcdecomp structure decompiler_source_tests/test2/tdm.scr > test2_validation.c
python -m vcdecomp structure decompiler_source_tests/test3/LEVEL.scr > test3_validation.c
```

2. **Check for undefined gotos:**
```bash
for file in test*_validation.c; do
  echo "=== $file ==="
  # Find all goto statements
  grep -n "goto block_" "$file" | while read line; do
    label=$(echo "$line" | sed -E 's/.*goto (block_[0-9]+).*/\1/')
    if ! grep -q "$label:" "$file"; then
      echo "UNDEFINED: $line"
    fi
  done
done > pattern1_check_results.txt
```

3. **Create PATTERN1_FIX_VALIDATION.md** with:
   - Results for each test file
   - Count of undefined gotos (should be 0 for all)
   - Comparison to ERROR_BASELINE.md Pattern 1 count (was ~50 instances)
   - Verification that fix is comprehensive

4. **Run pytest validation:**
```bash
PYTHONPATH=. python -m pytest vcdecomp/tests/test_validation.py -v > pattern1_pytest_results.txt 2>&1
```

Include pytest results in validation doc.
  </action>
  <verify>
```bash
cat C:/Users/flori/source/repos/VC_Scripter/.planning/phases/06-expression-reconstruction-fixes/PATTERN1_FIX_VALIDATION.md
cat C:/Users/flori/source/repos/VC_Scripter/pattern1_check_results.txt
```

Should show:
- 0 undefined gotos across all test files
- Pattern 1 fixed completely (down from ~50 instances)
- Pytest results showing compilation status
  </verify>
  <done>
PATTERN1_FIX_VALIDATION.md shows 0 undefined gotos in all test files, Pattern 1 fix verified comprehensive.
  </done>
</task>

<task type="auto">
  <name>Task 5: Commit fix with comprehensive documentation</name>
  <files>Multiple files</files>
  <action>
Commit the Pattern 1 fix with detailed commit message.

1. **Stage files:**
```bash
cd C:/Users/flori/source/repos/VC_Scripter
git add vcdecomp/core/ir/structure/orchestrator.py
git add .planning/phases/06-expression-reconstruction-fixes/PATTERN1_ROOT_CAUSE.md
git add .planning/phases/06-expression-reconstruction-fixes/PATTERN1_FIX_VALIDATION.md
```

2. **Commit with message:**
```bash
git commit -m "$(cat <<'EOF'
fix(06-06): fix Pattern 1 undefined goto labels (blocks 3, 46, 48)

Root cause: [Based on PATTERN1_ROOT_CAUSE.md hypothesis]

Fix: [Specific change made]

Verified:
- 0 undefined gotos in test1/tt.scr (was 3)
- 0 undefined gotos in test2/tdm.scr
- 0 undefined gotos in test3/LEVEL.scr
- Pattern 1 completely resolved (was ~50 instances in ERROR_BASELINE.md)

Evidence in PATTERN1_FIX_VALIDATION.md

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>
EOF
)"
```

DO NOT push - just commit locally.
  </action>
  <verify>
```bash
git log -1 --stat
git show --stat
```

Should show:
- Commit with comprehensive message
- orchestrator.py modified
- Two new .md files added
  </verify>
  <done>
Commit exists with Pattern 1 fix, root cause analysis, and validation docs.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **No undefined gotos exist:**
```bash
python -m vcdecomp structure decompiler_source_tests/test1/tt.scr > final_check.c
grep "goto block_" final_check.c | while read line; do
  label=$(echo "$line" | sed -E 's/.*goto (block_[0-9]+).*/\1/')
  grep -q "$label:" final_check.c || echo "FAIL: $line"
done
```
Should produce no output (no failures).

2. **Pattern 1 gaps closed in VERIFICATION-FINAL.md:**
- Gap 1 (undefined gotos) should be closable
- Blocks 3, 46, 48 either have labels or gotos removed

3. **Compilation progress measured:**
Run pytest validation to see if fixing Pattern 1 enables compilation (unlikely due to Pattern 2, but measure).
</verification>

<success_criteria>
- PATTERN1_ROOT_CAUSE.md exists with evidence-based hypothesis
- PATTERN1_FIX_VALIDATION.md shows 0 undefined gotos across all tests
- orchestrator.py modified with targeted fix (no [PATTERN1_DEBUG] logging remaining)
- Git commit contains fix with comprehensive documentation
- Gap 1 from 06-VERIFICATION-FINAL.md resolved
</success_criteria>

<output>
After completion, create `.planning/phases/06-expression-reconstruction-fixes/06-06-SUMMARY.md`

Summary should include:
- Root cause identified from debug output
- Fix implemented and validated
- Pattern 1 gaps fully closed
- Remaining gaps (Pattern 2 deferred to Phase 7)
- Final Phase 6 assessment: 3/6 patterns fixed, Pattern 1 NOW VERIFIED WORKING
</output>
