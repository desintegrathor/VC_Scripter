# Phase 01 Plan 01: Validation Menu and Trigger Implementation

---
phase: 01-gui-validation-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - vcdecomp/gui/main_window.py
autonomous: true

must_haves:
  truths:
    - User can click "Validate" in Tools menu to trigger validation
    - User can use Ctrl+Shift+V keyboard shortcut to trigger validation
    - Validation button appears in main toolbar for quick access
    - Validation shows error when no script is loaded
    - Validation triggers on currently displayed decompiled code without requiring save
  artifacts:
    - path: vcdecomp/gui/main_window.py
      provides: Validate action in Tools menu and toolbar
      min_lines: 400
      contains: "validate_current_script"
  key_links:
    - from: vcdecomp/gui/main_window.py
      to: ValidationPanel.start_validation
      via: method call in validate_current_script
      pattern: "self\\.validation_panel\\.start_validation"
---

## Objective

Add "Validate" action to GUI menu and toolbar that triggers validation of the currently displayed decompiled script.

**Purpose:** Enable users to validate scripts directly from the GUI with one click, satisfying VALID-01 requirement.

**Output:** MainWindow with integrated validation trigger that saves decompilation to temp file and invokes ValidationPanel.

## Execution Context

@C:\Users\flori\source\repos\VC_Scripter\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\flori\source\repos\VC_Scripter\.claude\get-shit-done\templates\summary.md

## Context

@C:\Users\flori\source\repos\VC_Scripter\.planning\PROJECT.md
@C:\Users\flori\source\repos\VC_Scripter\.planning\ROADMAP.md
@C:\Users\flori\source\repos\VC_Scripter\.planning\STATE.md
@C:\Users\flori\source\repos\VC_Scripter\.planning\phases\01-gui-validation-integration\01-RESEARCH.md

### Existing Code Context

@C:\Users\flori\source\repos\VC_Scripter\vcdecomp\gui\main_window.py
@C:\Users\flori\source\repos\VC_Scripter\vcdecomp\gui\views\validation_view.py

## Tasks

<task type="auto">
  <name>Add Validate action to Tools menu with keyboard shortcut</name>
  <files>vcdecomp/gui/main_window.py</files>
  <action>
Add "Validate" action to MainWindow:

1. In create_menus() method (line ~263), after Options menu creation, add Tools menu:
   - Create tools_menu = menubar.addMenu("&Tools")
   - Create validate_action with "&Validate Current Script" label
   - Set shortcut to "Ctrl+Shift+V" (avoid conflict with Ctrl+V paste)
   - Connect to self.validate_current_script method
   - Add to tools_menu

2. Create validate_current_script() method in MainWindow class:
   - Check if self.scr is None - if so, show QMessageBox.warning("No script loaded. Open a .scr file first.") and return
   - Get decompiled text from self.decomp_view.toPlainText()
   - Create temp directory: Path(tempfile.gettempdir()) / "vcdecomp_validation" (mkdir with exist_ok=True)
   - Save to temp file: temp_source = temp_dir / f"{Path(self.scr.filepath).stem}_decompiled.c"
   - Write decompiled_text to temp_source
   - Show validation dock: self.validation_dock.show()
   - Switch to validation dock tab if it's in tabbed mode
   - Call self.validation_panel.start_validation(original_scr=self.scr.filepath, decompiled_source=str(temp_source))

3. Import tempfile at top of file: `import tempfile`

Why this approach:
- Ctrl+Shift+V avoids conflict with standard Ctrl+V paste shortcut
- Temp file approach matches existing ValidationPanel API (expects file paths, not in-memory strings)
- Showing dock automatically improves UX (user sees validation starting immediately)
- Checking self.scr prevents cryptic errors when no script loaded
  </action>
  <verify>
1. Run GUI: `python -m vcdecomp gui`
2. Load test script: Open Compiler-testruns/Testrun1/tdm.scr
3. Check Tools menu exists with "Validate Current Script" option
4. Try validation without loading script first - should show warning dialog
5. After loading script, click Tools > Validate - validation dock should appear and validation should start
  </verify>
  <done>
- Tools menu exists in menubar with Validate action
- Ctrl+Shift+V shortcut works when script is loaded
- Validation shows warning when no script loaded
- Validation triggers ValidationPanel.start_validation() with temp file path
- Validation dock becomes visible when validation starts
  </done>
</task>

<task type="auto">
  <name>Add Validate button to main toolbar</name>
  <files>vcdecomp/gui/main_window.py</files>
  <action>
Add Validate button to main toolbar for quick access:

1. In init_ui() method, after creating central_tabs (line ~193), before dock widgets, add toolbar:
   - Create toolbar: self.toolbar = self.addToolBar("Main")
   - Add Open action to toolbar: self.toolbar.addAction(self.open_action) - NOTE: must save open_action as self.open_action in create_menus()
   - Add separator: self.toolbar.addSeparator()
   - Add validate action to toolbar: self.toolbar.addAction(self.validate_action) - NOTE: must save validate_action as self.validate_action in create_menus()

2. Update create_menus() to save actions as instance variables:
   - Change `open_action = QAction(...)` to `self.open_action = QAction(...)`
   - Change `validate_action = QAction(...)` to `self.validate_action = QAction(...)`
   - Use self.open_action and self.validate_action in menu.addAction() calls

3. Set icons for better UX (optional but recommended):
   - Import QStyle: from PyQt6.QtWidgets import QStyle
   - Set open icon: self.open_action.setIcon(self.style().standardIcon(QStyle.StandardPixmap.SP_DirOpenIcon))
   - Set validate icon: self.validate_action.setIcon(self.style().standardIcon(QStyle.StandardPixmap.SP_DialogApplyButton))

Why this approach:
- Toolbar provides one-click access (faster than navigating menu)
- Standard icons provide visual recognition without custom assets
- Toolbar creation before dock widgets ensures proper layout order
- Saving actions as instance variables allows reuse in both menu and toolbar
  </action>
  <verify>
1. Run GUI: `python -m vcdecomp gui`
2. Check main toolbar appears below menubar
3. Verify Open button appears with folder icon
4. Verify Validate button appears with checkmark/apply icon
5. Click Validate toolbar button without script - should show warning
6. Load script and click Validate toolbar button - should trigger validation
  </verify>
  <done>
- Main toolbar visible in GUI with Open and Validate buttons
- Validate toolbar button triggers same validate_current_script() method as menu action
- Icons appear for visual clarity (folder for Open, checkmark for Validate)
- Clicking Validate toolbar button shows validation dock and starts validation
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Validation trigger integration in MainWindow with menu action, keyboard shortcut, and toolbar button. The integration:
- Adds Tools menu with "Validate Current Script" action (Ctrl+Shift+V)
- Adds Validate button to main toolbar with icon
- Implements validate_current_script() that saves decompilation to temp file
- Connects to existing ValidationPanel.start_validation() method
- Shows validation dock automatically when validation starts
  </what-built>
  <how-to-verify>
**Test validation trigger flow:**

1. Start GUI:
   ```bash
   cd C:\Users\flori\source\repos\VC_Scripter
   python -m vcdecomp gui
   ```

2. Test without script loaded:
   - Click Tools > Validate Current Script (or use Ctrl+Shift+V or toolbar button)
   - Expected: Warning dialog "No script loaded. Open a .scr file first."

3. Test with script loaded:
   - Click File > Open
   - Navigate to `Compiler-testruns\Testrun1\tdm.scr`
   - Open the file
   - Wait for decompilation to appear in Decompilation tab
   - Click Tools > Validate Current Script (or toolbar Validate button)
   - Expected:
     * Validation dock appears at bottom of window
     * Progress bar starts animating
     * "Starting validation..." message appears
     * Eventually shows compilation results (success/failure with errors)

4. Test keyboard shortcut:
   - With tdm.scr still open, press Ctrl+Shift+V
   - Expected: Same validation flow as clicking menu/toolbar

5. Test toolbar button visibility:
   - Check toolbar below menubar has Open button (folder icon) and Validate button (checkmark icon)
   - Both buttons should be visually distinct and clickable

**Check temp file cleanup:**
6. Navigate to temp directory: `C:\Users\flori\AppData\Local\Temp\vcdecomp_validation\`
7. Verify temp .c file exists after validation runs
8. Note: File cleanup happens when validation completes or GUI closes (acceptable)
  </how-to-verify>
  <resume-signal>
Type "approved" if validation triggers correctly and shows results in ValidationPanel.

If issues found, describe the problem (e.g., "validation dock doesn't appear", "keyboard shortcut doesn't work", "temp file not created").
  </resume-signal>
</task>

## Verification

Overall validation checks for Plan 01:

1. **Menu integration:**
   - Tools menu exists in menubar
   - "Validate Current Script" action present with Ctrl+Shift+V shortcut

2. **Toolbar integration:**
   - Main toolbar visible below menubar
   - Validate button present with icon

3. **Trigger logic:**
   - validate_current_script() method checks for loaded script
   - Warning shown when no script loaded
   - Temp file created in vcdecomp_validation directory
   - ValidationPanel.start_validation() called with correct paths

4. **User experience:**
   - Validation dock appears automatically when validation starts
   - Progress updates visible in ValidationPanel
   - Results displayed in ValidationPanel (errors or bytecode diff)

## Success Criteria

**Measurable completion:**

- [ ] Tools menu contains "Validate Current Script" action with Ctrl+Shift+V shortcut
- [ ] Main toolbar contains Validate button with icon
- [ ] Clicking Validate without loaded script shows warning dialog
- [ ] Clicking Validate with loaded script triggers validation process
- [ ] Validation dock becomes visible and shows progress
- [ ] Validation results display in ValidationPanel (compilation errors or bytecode comparison)
- [ ] Temp decompiled .c file created in temp directory during validation

**Requirements satisfied:**
- [x] VALID-01: User can click "Compile" button in GUI to validate currently-open script

## Output

After completion, create `.planning/phases/01-gui-validation-integration/01-01-SUMMARY.md` documenting:
- Files modified (main_window.py changes)
- Integration points (validate_current_script method, menu/toolbar actions)
- Temp file handling approach
- User workflow (Tools menu → Validate → ValidationPanel shows results)
