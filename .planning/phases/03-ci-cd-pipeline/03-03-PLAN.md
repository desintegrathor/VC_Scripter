---
phase: 03-ci-cd-pipeline
plan: 03
type: execute
wave: 3
depends_on: ["03-02"]
files_modified:
  - .planning/baselines/test_validation/*.yml
autonomous: false

must_haves:
  truths:
    - "Pull requests require validation passing before merge"
    - "Workflow runs successfully on push to main"
    - "Workflow runs successfully on pull request creation"
    - "Previously-passing tests detect regressions when baseline changes"
  artifacts:
    - path: "GitHub repository settings"
      provides: "Branch protection rule for main"
      contains: "Require status checks: validate"
    - path: ".planning/baselines/test_validation/*.yml"
      provides: "Baseline YAML files for regression tracking"
      min_lines: 5
  key_links:
    - from: "Branch protection rule"
      to: ".github/workflows/validation.yml"
      via: "Required status check: validate (job name)"
      pattern: "validate.*job"
---

<objective>
Configure branch protection to require validation passing before merge, test complete CI flow end-to-end, and verify regression detection works correctly.

Purpose: Ensures broken code cannot be merged by making validation a required status check. Complete end-to-end testing validates the CI pipeline catches regressions as intended before relying on it in production.

Output: Production-ready CI/CD pipeline with enforced quality gates and verified regression detection.
</objective>

<execution_context>
@C:\Users\flori\source\repos\VC_Scripter\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\flori\source\repos\VC_Scripter\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@C:\Users\flori\source\repos\VC_Scripter\.planning\PROJECT.md
@C:\Users\flori\source\repos\VC_Scripter\.planning\ROADMAP.md
@C:\Users\flori\source\repos\VC_Scripter\.planning\STATE.md
@C:\Users\flori\source\repos\VC_Scripter\.planning\phases\03-ci-cd-pipeline\03-CONTEXT.md
@C:\Users\flori\source\repos\VC_Scripter\.planning\phases\03-ci-cd-pipeline\03-RESEARCH.md
@C:\Users\flori\source\repos\VC_Scripter\.planning\phases\03-ci-cd-pipeline\03-01-SUMMARY.md
@C:\Users\flori\source\repos\VC_Scripter\.planning\phases\03-ci-cd-pipeline\03-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Commit and Push CI Pipeline</name>
  <files>.git/refs/heads/main</files>
  <action>
  Commit the CI pipeline changes and push to trigger first workflow run:

  1. Extract GitHub username from git remote config:
     ```bash
     cd "C:\Users\flori\source\repos\VC_Scripter"

     # Get remote URL and extract username
     REMOTE_URL=$(git remote get-url origin)

     # Parse username from URL format:
     # - HTTPS: https://github.com/USERNAME/REPO.git
     # - SSH: git@github.com:USERNAME/REPO.git
     USERNAME=$(echo "$REMOTE_URL" | sed -E 's#.*/([^/]+)/[^/]+(.git)?$#\1#' | sed 's/.*://')

     echo "GitHub username: $USERNAME"
     ```

  2. Commit and push CI pipeline files:
     ```bash
     git add .github/workflows/validation.yml
     git add vcdecomp/requirements.txt
     git add vcdecomp/tests/test_validation.py
     git add vcdecomp/tests/conftest.py
     git add .planning/baselines/.gitkeep

     git commit -m "$(cat <<'EOF'
  feat(03-02): add GitHub Actions CI pipeline with regression baselines

  - GitHub Actions workflow for automated validation on push/PR
  - pytest plugins for CI integration (annotations, JSON reports, baselines)
  - Baseline regression testing to detect previously-passing scripts failing
  - Test result artifacts with 30-day retention
  - Self-hosted Windows runner targeting for SCMP.exe access
  - pytest-regressions configured to use .planning/baselines/ directory

  Requirements: VALID-05, TEST-06

  Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>
  EOF
  )"

     git push origin main
     ```

  This push will trigger the first workflow run on the main branch, which is necessary before configuring branch protection (per RESEARCH.md Pitfall 1).

  Wait for workflow to complete (check GitHub Actions tab at https://github.com/$USERNAME/VC_Scripter/actions).
  </action>
  <verify>
  ```bash
  git log --oneline -1
  ```
  Should show commit message "feat(03-02): add GitHub Actions CI pipeline..."

  Check GitHub Actions (use extracted username):
  ```bash
  # Extract username again for verification URL
  REMOTE_URL=$(git remote get-url origin)
  USERNAME=$(echo "$REMOTE_URL" | sed -E 's#.*/([^/]+)/[^/]+(.git)?$#\1#' | sed 's/.*://')
  echo "Check workflow at: https://github.com/$USERNAME/VC_Scripter/actions"
  ```

  Navigate to the URL and verify:
  1. "Decompilation Validation" workflow run triggered by push
  2. Wait for completion (green check or red X)
  </verify>
  <done>CI pipeline committed and pushed to main, first workflow run triggered and visible in GitHub Actions</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>First GitHub Actions workflow run on main branch</what-built>
  <how-to-verify>
  1. Extract GitHub username from git remote:
     ```bash
     cd "C:\Users\flori\source\repos\VC_Scripter"
     REMOTE_URL=$(git remote get-url origin)
     USERNAME=$(echo "$REMOTE_URL" | sed -E 's#.*/([^/]+)/[^/]+(.git)?$#\1#' | sed 's/.*://')
     echo "Navigate to: https://github.com/$USERNAME/VC_Scripter/actions"
     ```

  2. Verify the workflow run:
     - **Workflow name**: "Decompilation Validation"
     - **Trigger**: "push" event on main branch
     - **Status**: Should complete (green check or red X - both are acceptable)
     - **Job name**: "validate" appears in the job list
     - **Runner**: Shows "self-hosted" label (not "ubuntu-latest")

  3. Click into the workflow run and check:
     - "Setup Python 3.13" step succeeded
     - "Install dependencies" step succeeded
     - "Run validation tests" step executed (may fail - that's OK, tests are expected to fail)
     - "Upload test results" step succeeded (artifacts uploaded)
     - Artifacts section shows "test-results-[number]" downloadable artifact

  Expected state:
  - Workflow completed (regardless of test pass/fail)
  - Artifacts uploaded successfully
  - Job "validate" visible in GitHub (needed for branch protection)

  Common issues:
  - If runner shows "Queued": Check self-hosted runner is online in Settings > Actions > Runners
  - If "Setup Python" fails: Runner may need Python 3.13 installed locally
  - If tests fail: Expected - decompiler has bugs, we're just verifying CI infrastructure works
  </how-to-verify>
  <resume-signal>Type "verified" if workflow completed and artifacts uploaded, or describe any issues</resume-signal>
</task>

<task type="auto">
  <name>Generate Baseline Files on First Run</name>
  <files>.planning/baselines/test_validation/*.yml</files>
  <action>
  Run pytest locally with baseline regeneration to create initial baseline files:

  ```bash
  cd "C:\Users\flori\source\repos\VC_Scripter"

  # Verify baseline test function exists before running it
  grep -q "def test_decompilation_validation_with_baseline" vcdecomp/tests/test_validation.py || {
    echo "ERROR: Baseline test function not found in test_validation.py"
    exit 1
  }

  # Verify conftest.py has baseline directory configuration
  grep -q "pytest_regressions_data_dir" vcdecomp/tests/conftest.py || {
    echo "ERROR: pytest_regressions_data_dir fixture not found in conftest.py"
    exit 1
  }

  # Run baseline regression tests (will auto-generate YAML baselines on first run)
  py -m pytest vcdecomp/tests/test_validation.py::test_decompilation_validation_with_baseline -v

  # Verify pytest succeeded (exit code 0 or 1 acceptable - 1 means tests ran but some failed)
  PYTEST_EXIT=$?
  if [ $PYTEST_EXIT -gt 1 ]; then
    echo "ERROR: pytest failed with exit code $PYTEST_EXIT (collection/internal error)"
    exit 1
  fi

  # Verify baselines were generated
  if [ ! -d ".planning/baselines/test_validation" ]; then
    echo "ERROR: Baseline directory not created - check pytest_regressions_data_dir configuration"
    exit 1
  fi

  # Count baseline files (should be 3)
  BASELINE_COUNT=$(ls -1 .planning/baselines/test_validation/*.yml 2>/dev/null | wc -l)
  if [ $BASELINE_COUNT -ne 3 ]; then
    echo "WARNING: Expected 3 baseline files, found $BASELINE_COUNT"
  fi

  # Baselines auto-generated in .planning/baselines/test_validation/
  # Commit them to Git for version control
  git add .planning/baselines/
  git status
  ```

  pytest-regressions will create one YAML file per parametrized test case:
  - test_decompilation_validation_with_baseline_tt_turntable_.yml
  - test_decompilation_validation_with_baseline_tdm_deathmatch_.yml
  - test_decompilation_validation_with_baseline_level_script_.yml

  These baselines capture current test outcomes. Future test runs will compare against these baselines to detect regressions.

  Reference: RESEARCH.md "Pitfall 6: Baseline Files Not Committed After Regeneration"
  </action>
  <verify>
  ```bash
  # Verify baseline test function exists
  grep -c "def test_decompilation_validation_with_baseline" vcdecomp/tests/test_validation.py
  # Should return 1 (function exists)

  # Verify conftest fixture exists
  grep -c "pytest_regressions_data_dir" vcdecomp/tests/conftest.py
  # Should return 1 (fixture exists)

  # Verify baseline files generated
  ls .planning/baselines/test_validation/
  # Should show 3 YAML files (one per test case)

  cat .planning/baselines/test_validation/test_decompilation_validation_with_baseline_tt_turntable_.yml
  # Should show structured YAML with keys: verdict, compilation_succeeded, bytecode_identical, error_count, semantic_diffs
  ```

  All checks must pass:
  1. Baseline test function found in test_validation.py
  2. pytest_regressions_data_dir fixture found in conftest.py
  3. Three YAML files generated in .planning/baselines/test_validation/
  4. YAML contains expected keys (verdict, compilation_succeeded, etc.)
  </verify>
  <done>Baseline test function and conftest fixture verified present, baseline YAML files generated for all 3 test cases in .planning/baselines/test_validation/, ready to commit</done>
</task>

<task type="auto">
  <name>Commit Baseline Files</name>
  <files>.git/refs/heads/main</files>
  <action>
  Commit baseline files to Git for version-controlled regression tracking:

  ```bash
  cd "C:\Users\flori\source\repos\VC_Scripter"

  git add .planning/baselines/test_validation/

  git commit -m "$(cat <<'EOF'
  test(03-03): add initial test validation baselines

  Baseline outcomes for 3 test scripts (tt, tdm, LEVEL) captured for
  regression detection. Future test runs will compare against these
  baselines to alert when previously-passing scripts start failing.

  Generated by pytest-regressions on first test run.

  Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>
  EOF
  )"

  git push origin main
  ```

  This push will trigger another workflow run, now with baselines present.
  </action>
  <verify>
  ```bash
  git log --oneline -1
  ```
  Should show commit "test(03-03): add initial test validation baselines"

  Check GitHub Actions for second workflow run triggered by this push.
  </verify>
  <done>Baseline files committed to Git and pushed to main, triggering second workflow run with baselines present</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <action>Configure branch protection rule requiring validation</action>
  <instructions>
  Branch protection requires manual GitHub UI configuration (no API for self-hosted org repos):

  1. Extract GitHub username from git remote:
     ```bash
     cd "C:\Users\flori\source\repos\VC_Scripter"
     REMOTE_URL=$(git remote get-url origin)
     USERNAME=$(echo "$REMOTE_URL" | sed -E 's#.*/([^/]+)/[^/]+(.git)?$#\1#' | sed 's/.*://')
     echo "Navigate to: https://github.com/$USERNAME/VC_Scripter/settings/branches"
     ```

  2. Click "Add branch protection rule"

  3. Configure protection rule:
     - **Branch name pattern**: `main`
     - Check: "Require status checks to pass before merging"
       - Check: "Require branches to be up to date before merging"
       - Search for and select: "validate" (should appear in dropdown after workflow ran)
         - If "validate" doesn't appear, refresh page or wait - GitHub only shows checks that ran on main in last 7 days
     - Check: "Require a pull request before merging" (optional but recommended)
       - Uncheck "Require approvals" (solo project, no reviewers)

  4. Scroll to bottom and click "Create" button

  Expected state:
  - Branch protection rule active on main
  - "validate" check required for merge
  - PRs will be blocked if validation fails

  Troubleshooting:
  - If "validate" not in dropdown: Ensure workflow ran successfully on main (previous checkpoint)
  - If dropdown empty: Workflow may need to run again - push empty commit to trigger
  </instructions>
  <resume-signal>Type "configured" when branch protection rule is active</resume-signal>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete CI/CD pipeline with branch protection and regression detection</what-built>
  <how-to-verify>
  Test the complete CI flow with a pull request:

  **Step 1: Extract GitHub username**
  ```bash
  cd "C:\Users\flori\source\repos\VC_Scripter"
  REMOTE_URL=$(git remote get-url origin)
  USERNAME=$(echo "$REMOTE_URL" | sed -E 's#.*/([^/]+)/[^/]+(.git)?$#\1#' | sed 's/.*://')
  echo "GitHub username: $USERNAME"
  ```

  **Step 2: Create test branch with intentional regression**
  ```bash
  git checkout -b test-ci-regression

  # Modify baseline to simulate regression
  # Edit .planning/baselines/test_validation/test_decompilation_validation_with_baseline_tt_turntable_.yml
  # Change one value (e.g., error_count: 0 -> 999)
  ```

  **Step 3: Commit and push test branch**
  ```bash
  git add .planning/baselines/test_validation/test_decompilation_validation_with_baseline_tt_turntable_.yml
  git commit -m "test: simulate regression for CI testing"
  git push origin test-ci-regression
  ```

  **Step 4: Create pull request**
  - Navigate to: https://github.com/$USERNAME/VC_Scripter/pulls (use extracted username)
  - Click "New pull request"
  - Base: main, Compare: test-ci-regression
  - Click "Create pull request"

  **Step 5: Verify CI workflow and status checks**
  On the PR page, verify:
  1. "Decompilation Validation" workflow starts automatically
  2. Status check shows "Some checks haven't completed yet" while running
  3. After completion, status check shows failure (red X) due to baseline mismatch
  4. "Merge pull request" button is DISABLED (greyed out) with message "Merging is blocked"
  5. Message states: "Required status check 'validate' has not succeeded"

  **Step 6: Verify regression detection in test output**
  Click "Details" next to failed status check:
  - Should see pytest failure with baseline mismatch
  - Error shows expected vs actual values (error_count: 0 vs 999)

  **Step 7: Clean up test branch**
  ```bash
  git checkout main
  git branch -D test-ci-regression
  git push origin --delete test-ci-regression
  ```
  Close the PR without merging.

  Expected state:
  - Workflow runs on PR automatically
  - Failed validation blocks merge
  - Baseline regression is detected and reported
  - Branch protection prevents merging broken code
  </how-to-verify>
  <resume-signal>Type "verified" if PR validation blocked merge, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
1. First workflow run: Completed on main branch, artifacts uploaded
2. Baseline test function verified: grep confirms function exists before running pytest
3. Baseline directory fixture verified: grep confirms pytest_regressions_data_dir exists in conftest.py
4. Pytest execution verified: Exit code checked (0-1 acceptable, >1 is error)
5. Baselines generated: 3 YAML files in .planning/baselines/test_validation/
6. Baselines committed: Version-controlled in Git repository
7. Branch protection: "validate" status check required on main
8. Regression detection: Modified baseline triggers test failure
9. Merge blocking: Failed validation prevents PR merge
</verification>

<success_criteria>
- GitHub Actions workflow runs successfully on push to main
- Workflow runs successfully on pull request creation
- Test artifacts (JUnit XML, JSON report) upload on every workflow run
- Baseline test function existence verified before pytest execution (grep check passes)
- Baseline directory fixture verified in conftest.py (grep check passes)
- Pytest exit code verified (0-1 acceptable, errors on >1)
- Baseline YAML files exist for all 3 test cases in .planning/baselines/test_validation/
- Branch protection rule requires "validate" status check on main
- Pull requests with failing validation cannot be merged (button disabled)
- Regression detection works: changing baseline causes test failure and blocks merge
</success_criteria>

<output>
After completion, create `.planning/phases/03-ci-cd-pipeline/03-03-SUMMARY.md`
</output>
