# Phase 7 Plan 7: Gap Closure - Critical Compilation Fixes

---
phase: 07-variable-declaration-fixes
plan: 07
type: execute
wave: 7
depends_on: [07-01, 07-02, 07-03, 07-04, 07-05, 07-06a]
files_modified:
  - vcdecomp/core/ir/structure/analysis/variables.py
  - vcdecomp/core/ir/structure/emit/code_emitter.py
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Struct type inference has confidence scoring to prevent low-confidence overrides"
    - "Unreachable code after returns is detected and omitted from output"
    - "Pattern 2 struct-to-numeric assignments are eliminated"
    - "DOS compiler receives valid C code without dead code"
---

## Objective

Fix the top 2 critical compilation blockers preventing SCMP.exe from successfully compiling decompiled code:
1. **Pattern 2 Type Mismatches:** Struct variables assigned numeric literals/ints
2. **Unreachable Code:** Dead code after returns crashes DOS compiler

## Context

Phase 7 completed 6 plans implementing type inference infrastructure, but compilation still fails (0xC0000005 crash). Analysis of test1_complete.c reveals specific patterns causing the crash:

**Critical Issue 1 (lines 171-178):**
```c
s_SC_MP_EnumPlayers tmp6;  // Struct type
tmp6 = tmp5;               // int to struct - WRONG
tmp6 = 1084227584;         // numeric to struct - WRONG
tmp6 = 1092616192;         // numeric to struct - WRONG
return tmp6;               // returning struct from int function - WRONG
```

**Root Cause:** `variables.py` `inferred_struct_types` override opcode-based types without confidence scoring. Low-confidence struct guesses override high-confidence IADD/FADD opcode types.

**Critical Issue 2 (lines 127-130):**
```c
return TRUE;
SC_MP_LoadNextMap();  // Dead code
return TRUE;          // Dead code
SC_message("...");    // Dead code
```

**Root Cause:** DOS compiler crashes on unreachable code following unconditional returns.

## Tasks

### Task 1: Add Confidence Scoring to Struct Type Inference
**Type:** auto
**Files:** `vcdecomp/core/ir/structure/analysis/variables.py`

Add confidence scoring system to struct type inference to prevent low-confidence guesses from overriding high-confidence opcode-based types.

**Implementation:**
1. Add `confidence` field to struct type inference tracking
2. Score confidence based on evidence quality:
   - HIGH (0.8-1.0): Field access pattern matched with known struct
   - MEDIUM (0.5-0.8): Multiple field accesses, but ambiguous struct
   - LOW (0.0-0.5): Single field access or weak evidence
3. Update type priority logic:
   - Prefer opcode-based types (FLOAT/INT) over LOW confidence struct types
   - Only allow HIGH confidence struct types to override opcode types
   - MEDIUM confidence struct types only apply when no opcode type exists

**Done Criteria:**
- [ ] Confidence scoring added to struct type tracking
- [ ] Priority logic updated to respect confidence scores
- [ ] Test1 line 171-178: `tmp6` becomes `int` instead of `s_SC_MP_EnumPlayers`

**Verification:**
```bash
python -m vcdecomp structure C:\Users\flori\source\repos\VC_Scripter\decompiler_source_tests\test1\tt.scr > test1_task1.c
grep "s_SC_MP_EnumPlayers tmp6" test1_task1.c || echo "PASS: tmp6 no longer struct type"
```

### Task 2: Remove Unreachable Code After Returns
**Type:** auto
**Files:** `vcdecomp/core/ir/structure/emit/code_emitter.py`

Detect and omit unreachable code following unconditional returns to prevent DOS compiler crash.

**Implementation:**
1. Add unreachable code detection in code_emitter.py:
   - Track when unconditional return statement emitted
   - Mark subsequent statements in same block as unreachable
   - Skip emitting unreachable statements
2. Handle unconditional returns:
   - `return;` statements
   - `return <value>;` statements
   - Reset unreachable flag at block boundaries
3. Preserve comments for debugging:
   - Option: Emit `// UNREACHABLE: <statement>` as comment
   - Default: Omit silently for clean output

**Done Criteria:**
- [ ] Unreachable code detection implemented
- [ ] Test1 lines 127-130: Dead code after `return TRUE;` removed
- [ ] Clean output without dead code statements

**Verification:**
```bash
python -m vcdecomp structure C:\Users\flori\source\repos\VC_Scripter\decompiler_source_tests\test1\tt.scr > test1_task2.c
grep -A 3 "return TRUE;" test1_task2.c | grep "SC_MP_LoadNextMap" && echo "FAIL: Dead code still present" || echo "PASS: Dead code removed"
```

### Task 3: Validate Compilation Improvement
**Type:** auto
**Files:** None (validation only)

Run full compilation test to measure improvement vs Phase 7 baseline.

**Implementation:**
1. Decompile all 3 test files with fixes applied
2. Attempt compilation with SCMP.exe
3. Compare results to baseline (all 3 crash with 0xC0000005)
4. Document results in TASK3_VALIDATION.md

**Success Metrics:**
- **Minimum:** Compiler produces error file (doesn't crash)
- **Target:** At least 1 test compiles successfully
- **Stretch:** All 3 tests compile successfully

**Done Criteria:**
- [ ] 3 test files decompiled and compiled
- [ ] Results compared to baseline
- [ ] Validation report created

**Verification:**
```bash
cd C:\Users\flori\source\repos\VC_Scripter\original-resources\compiler
python -m vcdecomp structure ../../decompiler_source_tests/test1/tt.scr > test1_gap_closure.c
python -m vcdecomp structure ../../decompiler_source_tests/test2/tdm.scr > test2_gap_closure.c
python -m vcdecomp structure ../../decompiler_source_tests/test3/LEVEL.SCR > test3_gap_closure.c
# Compilation attempts tracked in TASK3_VALIDATION.md
```

## Success Criteria

1. **Pattern 2 Eliminated:** No struct variables assigned numeric literals or int values
2. **Unreachable Code Removed:** No dead code following unconditional returns
3. **Compilation Improvement:** Compiler either produces errors (vs crash) or succeeds
4. **Evidence-Based:** Validation report documents before/after comparison

## Deferred Issues

1. **ScriptMain Entry Block Detection:** Different root cause, needs separate investigation
2. **AttributeError in Structure Analysis:** Control flow issue, not type system related
3. **Multi-dimensional Arrays:** Infrastructure complete but detection needs refinement
4. **Cross-Function Goto:** Edge case from Pattern 1 (1 instance)

## Output

- Task 1: Modified `variables.py` with confidence scoring
- Task 2: Modified `code_emitter.py` with unreachable code detection
- Task 3: `TASK3_VALIDATION.md` with compilation results
- Summary: `07-07-SUMMARY.md` documenting gap closure success

---

*Gap closure plan to fix critical compilation blockers*
*Created: 2026-01-18*
