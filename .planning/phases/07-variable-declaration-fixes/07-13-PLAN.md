---
phase: 07-variable-declaration-fixes
plan: 13
type: execute
wave: 13
depends_on: [07-10, 07-11, 07-12]
files_modified: []
autonomous: false
gap_closure: true
requires_git_bash: true

must_haves:
  truths:
    - "At least 1/3 test files compile successfully with SCMP.exe"
    - "Compilation errors are actionable (not crashes or parse failures)"
    - "Gap 2 closed or remaining blockers identified for Phase 8"
  artifacts:
    - path: ".test_artifacts_07-13/test1_compile.log"
      provides: "test1 compilation attempt log"
      min_lines: 5
    - path: ".test_artifacts_07-13/test2_compile.log"
      provides: "test2 compilation attempt log"
      min_lines: 5
    - path: ".test_artifacts_07-13/test3_compile.log"
      provides: "test3 compilation attempt log"
      min_lines: 5
    - path: ".test_artifacts_07-13/compilation_summary.txt"
      provides: "Compilation results summary"
      contains: "SUCCESS.*[1-3]"
  key_links:
    - from: "Decompiled C code"
      to: "SCMP.exe compiler"
      via: "Compilation attempt with error capture"
      pattern: "scmp\\.exe.*\\.c"
    - from: "Compilation errors"
      to: "Gap 2 closure decision"
      via: "Error categorization and blocker identification"
      pattern: "ERROR.*|SUCCESS.*"
---

<objective>
Validate Gap 2 closure by attempting SCMP.exe compilation of all 3 test files after critical blocker elimination.

Purpose: Plans 07-10, 07-11, 07-12 eliminated critical blockers (Categories 1-5). This plan validates whether decompiled code now compiles successfully, measures improvement from Phase 6 baseline (0/3 tests with crashes), and determines if Gap 2 can be closed or if Phase 8 is required.

Output: Compilation results showing success rate, error categorization, and Gap 2 status decision.

Note: This plan depends on ALL THREE prior plans (07-10, 07-11, 07-12) completing successfully. If any prior plan's fixes fail, this validation will fail with unclear errors.
</objective>

<execution_context>
@C:\Users\flori\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\flori\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@C:\Users\flori\source\repos\VC_Scripter\.planning\PROJECT.md
@C:\Users\flori\source\repos\VC_Scripter\.planning\ROADMAP.md
@C:\Users\flori\source\repos\VC_Scripter\.planning\STATE.md
@C:\Users\flori\source\repos\VC_Scripter\.planning\phases\07-variable-declaration-fixes\07-VERIFICATION.md
@C:\Users\flori\source\repos\VC_Scripter\.planning\phases\07-variable-declaration-fixes\07-09-SUMMARY.md
@C:\Users\flori\source\repos\VC_Scripter\.planning\phases\07-variable-declaration-fixes\07-10-SUMMARY.md
@C:\Users\flori\source\repos\VC_Scripter\.planning\phases\07-variable-declaration-fixes\07-11-SUMMARY.md
@C:\Users\flori\source\repos\VC_Scripter\.planning\phases\07-variable-declaration-fixes\07-12-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify Prior Fixes Applied</name>
  <files>.test_artifacts_07-13/fixes_verification.txt</files>
  <action>
Verify that all prior plans (07-10, 07-11, 07-12) actually applied their fixes before attempting compilation.

**Critical pre-flight checks:**

1. **07-10 fix verification (debug pollution + ScriptMain):**
```bash
cd "C:\Users\flori\source\repos\VC_Scripter"
mkdir -p .test_artifacts_07-13

echo "=== Pre-flight Fix Verification ===" > .test_artifacts_07-13/fixes_verification.txt
echo "" >> .test_artifacts_07-13/fixes_verification.txt

echo "07-10 Fix 1: Debug logging changed to logger.debug?" >> .test_artifacts_07-13/fixes_verification.txt
grep -q "logger.debug.*orphaned" vcdecomp/core/ir/structure/orchestrator.py && \
    echo "  PASS: logger.debug found" >> .test_artifacts_07-13/fixes_verification.txt || \
    echo "  FAIL: logger.warning still present" >> .test_artifacts_07-13/fixes_verification.txt

echo "" >> .test_artifacts_07-13/fixes_verification.txt
echo "07-10 Fix 2: ScriptMain entry block detection fixed?" >> .test_artifacts_07-13/fixes_verification.txt
grep -rn "entry block not found" vcdecomp/ > .test_artifacts_07-13/error_location.txt
if [ -s .test_artifacts_07-13/error_location.txt ]; then
    echo "  Location: $(cat .test_artifacts_07-13/error_location.txt)" >> .test_artifacts_07-13/fixes_verification.txt
    echo "  Check: Verify cfg.entry_block usage or improved fallback" >> .test_artifacts_07-13/fixes_verification.txt
else
    echo "  PASS: No error message generation found" >> .test_artifacts_07-13/fixes_verification.txt
fi
```

2. **07-11 fix verification (void return types):**
```bash
echo "" >> .test_artifacts_07-13/fixes_verification.txt
echo "07-11 Fix: Return type inference distinguishes void vs int?" >> .test_artifacts_07-13/fixes_verification.txt
if grep -A 5 "elif instr.mnemonic == \"RET\"" vcdecomp/core/ir/function_signature.py | grep -q "void"; then
    echo "  PASS: Void return type logic present" >> .test_artifacts_07-13/fixes_verification.txt
else
    echo "  FAIL: Still defaults all functions to int" >> .test_artifacts_07-13/fixes_verification.txt
fi
```

3. **07-12 fix verification (unreachable code):**
```bash
echo "" >> .test_artifacts_07-13/fixes_verification.txt
echo "07-12 Fix: Generic return detection implemented?" >> .test_artifacts_07-13/fixes_verification.txt
if grep -q "startswith.*return" vcdecomp/core/ir/structure/emit/block_formatter.py; then
    echo "  PASS: Generic return detection found" >> .test_artifacts_07-13/fixes_verification.txt
else
    echo "  FAIL: Return detection missing or too specific" >> .test_artifacts_07-13/fixes_verification.txt
fi

echo "" >> .test_artifacts_07-13/fixes_verification.txt
echo "=== Pre-flight Complete ===" >> .test_artifacts_07-13/fixes_verification.txt
cat .test_artifacts_07-13/fixes_verification.txt

# Check for any FAIL status
if grep -q "FAIL:" .test_artifacts_07-13/fixes_verification.txt; then
    echo ""
    echo "ERROR: Prior fixes not fully applied. Review fixes_verification.txt"
    echo "Compilation will likely fail without these fixes."
fi
```

**Why this matters:**
- Task 1 in each prior plan changes SOURCE CODE
- This verification confirms CODE was changed, not just OUTPUT
- If fixes weren't applied, compilation will fail with original errors
- Early detection prevents wasted compilation attempts
  </action>
  <verify>
NOTE: Requires Git Bash (bash.exe) available in PATH.

```bash
# Review verification results
cat .test_artifacts_07-13/fixes_verification.txt

# Count PASSes and FAILs
PASS_COUNT=$(grep -c "PASS:" .test_artifacts_07-13/fixes_verification.txt)
FAIL_COUNT=$(grep -c "FAIL:" .test_artifacts_07-13/fixes_verification.txt)

echo ""
echo "Fix verification: ${PASS_COUNT} PASS, ${FAIL_COUNT} FAIL"

if [ ${FAIL_COUNT} -gt 0 ]; then
    echo "WARNING: Not all fixes applied - compilation may fail"
else
    echo "SUCCESS: All fixes verified"
fi
```
  </verify>
  <done>
- fixes_verification.txt shows verification of all 3 prior plans
- Each fix verified at SOURCE CODE level (not just output)
- PASS/FAIL status for each fix documented
- Any failures flagged before compilation attempt
  </done>
</task>

<task type="auto">
  <name>Task 2: Attempt SCMP.exe Compilation</name>
  <files>.test_artifacts_07-13/test1_compile.log, .test_artifacts_07-13/test2_compile.log, .test_artifacts_07-13/test3_compile.log</files>
  <action>
Compile all 3 decompiled test files with SCMP.exe and capture results.

**Compilation setup:**

1. **Prepare test artifacts directory:**
```bash
cd "C:\Users\flori\source\repos\VC_Scripter"
mkdir -p .test_artifacts_07-13
```

2. **Decompile all test files with latest fixes:**
```bash
# Decompile with all 07-10, 07-11, 07-12 fixes applied
python -m vcdecomp structure "decompiler_source_tests/test1/tt.scr" > .test_artifacts_07-13/test1.c 2>&1
python -m vcdecomp structure "decompiler_source_tests/test2/tdm.scr" > .test_artifacts_07-13/test2.c 2>&1
python -m vcdecomp structure "decompiler_source_tests/test3/LEVEL.SCR" > .test_artifacts_07-13/test3.c 2>&1
```

3. **Compile each test with SCMP.exe:**
```bash
# Copy compiler to test directory
cp original-resources/compiler/scc.exe .test_artifacts_07-13/
cp original-resources/compiler/spp.exe .test_artifacts_07-13/
cp original-resources/compiler/scmp.exe .test_artifacts_07-13/
cp -r original-resources/compiler/inc .test_artifacts_07-13/

# Test1 compilation
cd .test_artifacts_07-13
./scmp.exe test1.c test1.scr inc/sc_global.h > test1_compile.log 2>&1
TEST1_EXIT=$?
echo "Exit code: ${TEST1_EXIT}" >> test1_compile.log

# Test2 compilation
./scmp.exe test2.c test2.scr inc/sc_global.h > test2_compile.log 2>&1
TEST2_EXIT=$?
echo "Exit code: ${TEST2_EXIT}" >> test2_compile.log

# Test3 compilation
./scmp.exe test3.c test3.scr inc/sc_global.h > test3_compile.log 2>&1
TEST3_EXIT=$?
echo "Exit code: ${TEST3_EXIT}" >> test3_compile.log

cd ..
```

4. **Check for crashes vs compilation errors:**
```bash
# Crash detection (exit code 0xC0000005 or similar)
for test in test1 test2 test3; do
    echo "=== ${test} result ===" >> .test_artifacts_07-13/crash_check.txt
    if [ -f ".test_artifacts_07-13/${test}.scr" ]; then
        echo "SUCCESS: .scr file generated" >> .test_artifacts_07-13/crash_check.txt
    elif grep -q "error" ".test_artifacts_07-13/${test}_compile.log"; then
        echo "COMPILATION ERROR: Check log for details" >> .test_artifacts_07-13/crash_check.txt
    else
        echo "CRASH or PARSE FAILURE: No .scr, no errors" >> .test_artifacts_07-13/crash_check.txt
    fi
done

cat .test_artifacts_07-13/crash_check.txt
```

**Expected outcomes:**

- **Best case:** 1+ tests compile successfully (.scr file generated)
- **Good case:** All tests show compilation errors (no crashes) - parseable code
- **Requires Phase 8:** Crashes persist or new blocker categories identified

**Why this validation matters:**
- Baseline (06-VERIFICATION): 0/3 tests, all crash with 0xC0000005
- After fixes: Target 1+/3 success (measurable improvement)
- Compilation errors (not crashes) show progress - code is parseable
  </action>
  <verify>
NOTE: Requires Git Bash (bash.exe) available in PATH.

```bash
# Verify compilation attempt logs exist
ls -lh .test_artifacts_07-13/*_compile.log

# Check for success indicators (.scr files)
ls -lh .test_artifacts_07-13/*.scr 2>/dev/null && echo "SUCCESS: At least one .scr file generated" || echo "NO SUCCESS: No .scr files"

# Display crash check summary
cat .test_artifacts_07-13/crash_check.txt
```
  </verify>
  <done>
- test1_compile.log, test2_compile.log, test3_compile.log exist
- crash_check.txt categorizes each result (SUCCESS/ERROR/CRASH)
- At least 1/3 tests show SUCCESS or COMPILATION ERROR (not CRASH)
- Compilation logs captured for error analysis
- Fix verification confirmed changes were applied before compilation
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Compilation attempt completed for all 3 test files after critical blocker elimination (07-10, 07-11, 07-12).

Files:
- .test_artifacts_07-13/test1.c → test1_compile.log
- .test_artifacts_07-13/test2.c → test2_compile.log
- .test_artifacts_07-13/test3.c → test3_compile.log
- .test_artifacts_07-13/crash_check.txt (summary)
- .test_artifacts_07-13/fixes_verification.txt (pre-flight check)
  </what-built>
  <how-to-verify>
1. Review fix verification to confirm all changes applied:
```bash
cat C:\Users\flori\source\repos\VC_Scripter\.test_artifacts_07-13\fixes_verification.txt
```

2. Review crash_check.txt summary:
```bash
cat C:\Users\flori\source\repos\VC_Scripter\.test_artifacts_07-13\crash_check.txt
```

3. Check compilation logs for each test:
```bash
# test1 result
head -50 C:\Users\flori\source\repos\VC_Scripter\.test_artifacts_07-13\test1_compile.log

# test2 result
head -50 C:\Users\flori\source\repos\VC_Scripter\.test_artifacts_07-13\test2_compile.log

# test3 result
head -50 C:\Users\flori\source\repos\VC_Scripter\.test_artifacts_07-13\test3_compile.log
```

4. Check for .scr output files (success indicator):
```bash
ls C:\Users\flori\source\repos\VC_Scripter\.test_artifacts_07-13\*.scr
```

5. **Decision criteria:**

   **Gap 2 CAN BE CLOSED if:**
   - At least 1/3 tests compile successfully (.scr file generated)
   - OR all tests show compilation errors (no crashes) - code is parseable
   - Measurable improvement from baseline (0/3 with crashes)

   **Phase 8 REQUIRED if:**
   - All tests still crash (no improvement)
   - New critical blockers identified (beyond Categories 1-5)
   - Compilation errors too numerous to address in current phase

   **FIXES NOT APPLIED if:**
   - fixes_verification.txt shows FAIL status
   - Retry plans 07-10, 07-11, or 07-12 to apply fixes

6. Provide your assessment:
   - How many tests compiled successfully?
   - How many show compilation errors vs crashes?
   - Were all fixes verified as applied?
   - Should Gap 2 be closed or Phase 8 required?
   - Any new blocker categories discovered?
  </how-to-verify>
  <resume-signal>
Type one of:
- "gap-closed" - At least 1/3 tests compile, Gap 2 resolved
- "phase-8-required" - Need additional fixes
- "analyze-errors" - Need detailed error analysis before decision
- "retry-fixes" - Fix verification failed, need to re-run prior plans

Include any notes about new blocker categories or unexpected results.
  </resume-signal>
</task>

<task type="auto">
  <name>Task 3: Generate Compilation Summary Report</name>
  <files>.test_artifacts_07-13/compilation_summary.txt</files>
  <action>
Create comprehensive compilation summary with Gap 2 closure decision.

**Report structure:**

```bash
cd "C:\Users\flori\source\repos\VC_Scripter"

echo "=== Phase 7 Compilation Validation Report ===" > .test_artifacts_07-13/compilation_summary.txt
echo "Date: $(date)" >> .test_artifacts_07-13/compilation_summary.txt
echo "" >> .test_artifacts_07-13/compilation_summary.txt

echo "=== Baseline (Phase 6, from 06-VERIFICATION.md) ===" >> .test_artifacts_07-13/compilation_summary.txt
echo "test1: CRASH (0xC0000005)" >> .test_artifacts_07-13/compilation_summary.txt
echo "test2: CRASH (0xC0000005)" >> .test_artifacts_07-13/compilation_summary.txt
echo "test3: CRASH (0xC0000005)" >> .test_artifacts_07-13/compilation_summary.txt
echo "Success rate: 0/3 (0%)" >> .test_artifacts_07-13/compilation_summary.txt
echo "" >> .test_artifacts_07-13/compilation_summary.txt

echo "=== After Gap Closure (Plans 07-10, 07-11, 07-12) ===" >> .test_artifacts_07-13/compilation_summary.txt

# Parse results from crash_check.txt
SUCCESS_COUNT=$(grep -c "SUCCESS" .test_artifacts_07-13/crash_check.txt || echo "0")
ERROR_COUNT=$(grep -c "COMPILATION ERROR" .test_artifacts_07-13/crash_check.txt || echo "0")
CRASH_COUNT=$(grep -c "CRASH" .test_artifacts_07-13/crash_check.txt || echo "0")

echo "test1: $(grep "test1 result" -A 1 .test_artifacts_07-13/crash_check.txt | tail -1)" >> .test_artifacts_07-13/compilation_summary.txt
echo "test2: $(grep "test2 result" -A 1 .test_artifacts_07-13/crash_check.txt | tail -1)" >> .test_artifacts_07-13/compilation_summary.txt
echo "test3: $(grep "test3 result" -A 1 .test_artifacts_07-13/crash_check.txt | tail -1)" >> .test_artifacts_07-13/compilation_summary.txt
echo "" >> .test_artifacts_07-13/compilation_summary.txt

echo "SUCCESS: ${SUCCESS_COUNT}/3" >> .test_artifacts_07-13/compilation_summary.txt
echo "COMPILATION ERROR: ${ERROR_COUNT}/3" >> .test_artifacts_07-13/compilation_summary.txt
echo "CRASH: ${CRASH_COUNT}/3" >> .test_artifacts_07-13/compilation_summary.txt
echo "" >> .test_artifacts_07-13/compilation_summary.txt

# Calculate improvement
PARSEABLE=$((SUCCESS_COUNT + ERROR_COUNT))
echo "Parseable by SCMP.exe: ${PARSEABLE}/3 (improvement from 0/3)" >> .test_artifacts_07-13/compilation_summary.txt
echo "" >> .test_artifacts_07-13/compilation_summary.txt

echo "=== Critical Blockers Eliminated ===" >> .test_artifacts_07-13/compilation_summary.txt
echo "Category 1: Debug logging pollution (07-10)" >> .test_artifacts_07-13/compilation_summary.txt
echo "Category 2: Broken ScriptMain (07-10)" >> .test_artifacts_07-13/compilation_summary.txt
echo "Category 3: Void return values (07-11)" >> .test_artifacts_07-13/compilation_summary.txt
echo "Category 4: Uninitialized variables (DEFERRED)" >> .test_artifacts_07-13/compilation_summary.txt
echo "Category 5: Unreachable code (07-12)" >> .test_artifacts_07-13/compilation_summary.txt
echo "" >> .test_artifacts_07-13/compilation_summary.txt

echo "=== Gap 2 Status ===" >> .test_artifacts_07-13/compilation_summary.txt
if [ ${SUCCESS_COUNT} -gt 0 ]; then
    echo "STATUS: CLOSED - At least 1/3 tests compile successfully" >> .test_artifacts_07-13/compilation_summary.txt
elif [ ${PARSEABLE} -gt 0 ]; then
    echo "STATUS: PARTIAL - Code parseable but compilation errors remain" >> .test_artifacts_07-13/compilation_summary.txt
    echo "RECOMMENDATION: Review compilation errors, consider Phase 8 for semantic fixes" >> .test_artifacts_07-13/compilation_summary.txt
else
    echo "STATUS: OPEN - Crashes persist, Phase 8 required" >> .test_artifacts_07-13/compilation_summary.txt
fi

echo "" >> .test_artifacts_07-13/compilation_summary.txt
echo "=== Next Steps ===" >> .test_artifacts_07-13/compilation_summary.txt
if [ ${SUCCESS_COUNT} -gt 0 ]; then
    echo "- Update 07-VERIFICATION.md: Gap 2 CLOSED" >> .test_artifacts_07-13/compilation_summary.txt
    echo "- Mark Phase 7 as COMPLETE" >> .test_artifacts_07-13/compilation_summary.txt
    echo "- Proceed to Phase 8 (Control Flow Fixes) or Phase 9 (Reporting)" >> .test_artifacts_07-13/compilation_summary.txt
else
    echo "- Analyze compilation error logs for new blocker patterns" >> .test_artifacts_07-13/compilation_summary.txt
    echo "- Create Phase 8 plans for semantic error fixes" >> .test_artifacts_07-13/compilation_summary.txt
    echo "- Phase 7 remains INCOMPLETE until compilation success achieved" >> .test_artifacts_07-13/compilation_summary.txt
fi

cat .test_artifacts_07-13/compilation_summary.txt
```
  </action>
  <verify>
NOTE: Requires Git Bash (bash.exe) available in PATH.

```bash
# Display final compilation summary
cat .test_artifacts_07-13/compilation_summary.txt

# Verify improvement from baseline
echo ""
echo "=== Improvement Summary ==="
echo "Baseline: 0/3 tests (all crashed)"
echo "After gap closure: $(grep "SUCCESS:" .test_artifacts_07-13/compilation_summary.txt)"
```
  </verify>
  <done>
- compilation_summary.txt shows baseline vs current results
- Success count, error count, crash count tallied
- Gap 2 status decision documented (CLOSED/PARTIAL/OPEN)
- Next steps provided based on results
- Measurable improvement from Phase 6 baseline documented
- Fix verification results included in assessment
  </done>
</task>

</tasks>

<verification>
## Gap 2 Closure Verification

**Success Criteria:**
1. At least 1/3 tests compile successfully (generate .scr files)
2. OR all tests parseable by SCMP.exe (compilation errors, not crashes)
3. Measurable improvement from Phase 6 baseline (0/3 with crashes)
4. All prior fixes verified as applied before compilation

**Verification Commands:**
```bash
# Check fix verification status
grep "PASS\|FAIL" .test_artifacts_07-13/fixes_verification.txt

# Check success rate
ls .test_artifacts_07-13/*.scr | wc -l
# Expected: 1+ (at least one .scr file)

# Check compilation logs for errors vs crashes
for log in .test_artifacts_07-13/*_compile.log; do
    echo "=== $(basename $log) ==="
    if grep -q "error" "$log"; then
        echo "Compilation errors (code is parseable)"
    elif [ -f "${log/.log/.scr}" ]; then
        echo "SUCCESS - .scr file generated"
    else
        echo "CRASH or parse failure"
    fi
done
```

**Gap 2 Closure Decision:**
- **CLOSED**: Success count ≥ 1, or all tests show compilation errors (not crashes)
- **PARTIAL**: Some improvement but issues remain, Phase 8 recommended
- **OPEN**: No improvement, Phase 8 required

</verification>

<success_criteria>
## Gap 2 Final Validation

**Measurable Outcomes:**
1. Compilation success rate: Target 1+/3 tests (improvement from 0/3)
2. Parseable code rate: Target 3/3 tests (no crashes)
3. Critical blockers (Categories 1-5): Verified as eliminated
4. Fix verification: All PASS status

**Acceptance Test:**
```bash
# Success if ANY test compiles
cd C:\Users\flori\source\repos\VC_Scripter\.test_artifacts_07-13
if ls *.scr 2>/dev/null; then
    echo "PASS: At least one test compiled successfully"
    exit 0
else
    echo "FAIL: No tests compiled successfully"
    exit 1
fi
```

**Phase 7 Completion:**
- If Gap 2 CLOSED: Phase 7 marked COMPLETE
- If Gap 2 PARTIAL/OPEN: Phase 7 marked INCOMPLETE, Phase 8 required

**Documentation:**
- Update 07-VERIFICATION.md with Gap 2 status
- Update ROADMAP.md Phase 7 status
- Update STATE.md current position
</success_criteria>

<output>
After completion, create `.planning/phases/07-variable-declaration-fixes/07-13-SUMMARY.md` with:
- Fix verification results (all PASS/FAIL statuses)
- Compilation results for all 3 tests (success/error/crash)
- Comparison to Phase 6 baseline (0/3 crashed)
- Gap 2 closure decision with rationale
- Error analysis if compilation errors remain
- Phase 7 completion status and next phase recommendation
</output>
