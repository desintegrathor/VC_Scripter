---
phase: 04-error-analysis-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - vcdecomp/validation/error_analyzer.py
  - vcdecomp/tests/test_validation.py
autonomous: true

must_haves:
  truths:
    - "Compilation errors are automatically categorized by type (syntax, semantic, type, include, other)"
    - "Error patterns can be aggregated across multiple validation results"
    - "Error categorization logic is reusable across GUI, tests, and CLI"
  artifacts:
    - path: "vcdecomp/validation/error_analyzer.py"
      provides: "Error categorization and pattern detection"
      exports: ["ErrorAnalyzer", "categorize_compilation_errors", "ErrorPattern"]
      min_lines: 150
    - path: "vcdecomp/tests/test_validation.py"
      provides: "Updated to use error_analyzer module"
      contains: "from vcdecomp.validation.error_analyzer import categorize_compilation_errors"
  key_links:
    - from: "vcdecomp/validation/error_analyzer.py"
      to: "CompilationError"
      via: "import from compilation_types"
      pattern: "from.*compilation_types import CompilationError"
    - from: "vcdecomp/tests/test_validation.py"
      to: "error_analyzer.categorize_compilation_errors"
      via: "function call replacement"
      pattern: "categorize_compilation_errors\\(result\\.compilation_result\\.errors\\)"
---

<objective>
Extract and enhance error categorization logic into reusable module with pattern aggregation capabilities.

Purpose: Satisfy ERROR-01 and ERROR-02 requirements by creating programmatic error analysis foundation. This module enables systematic classification ("syntax errors", "type errors") and pattern detection ("70% are switch/case bugs") for guiding decompiler fixes.

Output: Standalone error_analyzer.py module with ErrorAnalyzer class for batch analysis, categorization function for single-result analysis, and data structures for representing error patterns.
</objective>

<execution_context>
@C:\Users\flori\source\repos\VC_Scripter\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\flori\source\repos\VC_Scripter\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@C:\Users\flori\source\repos\VC_Scripter\.planning\PROJECT.md
@C:\Users\flori\source\repos\VC_Scripter\.planning\ROADMAP.md
@C:\Users\flori\source\repos\VC_Scripter\.planning\STATE.md
@C:\Users\flori\source\repos\VC_Scripter\.planning\phases\04-error-analysis-system\04-CONTEXT.md
@C:\Users\flori\source\repos\VC_Scripter\.planning\phases\04-error-analysis-system\04-RESEARCH.md
@C:\Users\flori\source\repos\VC_Scripter\vcdecomp\validation\compilation_types.py
@C:\Users\flori\source\repos\VC_Scripter\vcdecomp\validation\validation_types.py
@C:\Users\flori\source\repos\VC_Scripter\vcdecomp\tests\test_validation.py
</context>

<tasks>

<task type="auto">
  <name>Create error_analyzer.py module with categorization and pattern detection</name>
  <files>vcdecomp/validation/error_analyzer.py</files>
  <action>
Create vcdecomp/validation/error_analyzer.py with:

1. **categorize_compilation_errors() function:**
   - Extract from test_validation.py lines 154-173
   - Input: List[CompilationError]
   - Output: Dict[str, List[CompilationError]] mapping error types to error lists
   - Categories: "syntax", "semantic", "type", "include", "other"
   - Use keyword matching (per RESEARCH.md Pattern 1):
     - syntax: "syntax" or "expected" in message
     - semantic: "undefined" or "undeclared" or "not declared" in message
     - type: "type" or "incompatible" in message
     - include: "include" or "cannot open" in message
     - other: everything else
   - Include docstring documenting known error patterns

2. **ErrorPattern dataclass:**
   - Fields: error_type (str), count (int), percentage (float), examples (List[CompilationError])
   - Represents aggregated pattern across multiple validation runs
   - Include __str__ for human-readable formatting

3. **ErrorAnalyzer class:**
   - Purpose: Aggregate errors across batch validation results
   - Method: analyze_batch_results(results: List[ValidationResult]) -> List[ErrorPattern]
   - Implementation (per RESEARCH.md Pattern 3):
     - Iterate through results, categorize each result's errors
     - Accumulate counts by error_type
     - Store first 3 examples of each type
     - Calculate percentages
     - Return sorted by count (descending)
   - Method: generate_insights() -> List[str]
     - Returns human-readable insights: "70.5% (142) are syntax errors"
     - Sorted by frequency (most common first)

4. **Type hints:**
   - Import CompilationError, ValidationResult from compilation_types, validation_types
   - Full type annotations on all functions and class methods
   - Use from __future__ import annotations for forward references

5. **Module docstring:**
   - Document purpose: "Error categorization and pattern detection for compilation failures"
   - Document usage examples for both single-result and batch analysis
  </action>
  <verify>
python -c "from vcdecomp.validation.error_analyzer import categorize_compilation_errors, ErrorAnalyzer, ErrorPattern; print('Imports successful')"
  </verify>
  <done>
Module imports successfully, categorize_compilation_errors function callable, ErrorAnalyzer class instantiable, ErrorPattern dataclass defined with required fields
  </done>
</task>

<task type="auto">
  <name>Update test_validation.py to use error_analyzer module</name>
  <files>vcdecomp/tests/test_validation.py</files>
  <action>
Update vcdecomp/tests/test_validation.py to use new error_analyzer module:

1. **Add import:**
   - Add: from vcdecomp.validation.error_analyzer import categorize_compilation_errors
   - Remove inline categorize_compilation_errors function (lines 154-173)

2. **Update test function:**
   - Keep existing calls to categorize_compilation_errors (lines using it in error breakdown)
   - No behavior changes - function signature identical
   - Verify no other parts of test depend on inline implementation

3. **Preserve test logic:**
   - Do NOT modify test assertions or output formatting
   - Do NOT change error reporting structure
   - Only change is import source, not functionality

**What to avoid:**
- Do NOT modify categorization logic (already tested, move as-is)
- Do NOT change test expectations or assertions
- Do NOT add new tests (this is refactoring only)
  </action>
  <verify>
PYTHONPATH=C:\Users\flori\source\repos\VC_Scripter python -m pytest vcdecomp/tests/test_validation.py -v --co
  </verify>
  <done>
Tests discover successfully, imports resolve, no syntax errors, categorize_compilation_errors called from error_analyzer module
  </done>
</task>

<task type="auto">
  <name>Add unit tests for error_analyzer module</name>
  <files>vcdecomp/tests/test_error_analyzer.py</files>
  <action>
Create vcdecomp/tests/test_error_analyzer.py with pytest tests:

1. **Test categorize_compilation_errors:**
   - Create mock CompilationError objects with various messages
   - Test syntax categorization ("expected ';'", "syntax error")
   - Test semantic categorization ("undefined symbol 'foo'", "undeclared identifier")
   - Test type categorization ("type mismatch", "incompatible types")
   - Test include categorization ("cannot open include file", "include not found")
   - Test other category (unmatched messages)
   - Assert correct categorization and list grouping

2. **Test ErrorAnalyzer.analyze_batch_results:**
   - Create mock ValidationResult objects with varied error distributions
   - Test pattern detection across multiple results
   - Verify counts, percentages, examples storage
   - Test sorting by frequency

3. **Test ErrorAnalyzer.generate_insights:**
   - Test human-readable insight generation
   - Verify percentage formatting and sorting

**Test data:**
- Use CompilationError with CompilationStage.SCC and ErrorSeverity.ERROR
- Use minimal ValidationResult mocks (only compilation_result field needed)
- 3-5 test cases covering main scenarios
  </action>
  <verify>
PYTHONPATH=C:\Users\flori\source\repos\VC_Scripter python -m pytest vcdecomp/tests/test_error_analyzer.py -v
  </verify>
  <done>
All tests pass, error categorization works correctly, pattern aggregation produces expected counts and percentages
  </done>
</task>

</tasks>

<verification>
1. Module imports without errors: `python -c "from vcdecomp.validation.error_analyzer import *"`
2. Existing validation tests still pass: `pytest vcdecomp/tests/test_validation.py -v`
3. New error_analyzer tests pass: `pytest vcdecomp/tests/test_error_analyzer.py -v`
4. No circular imports or dependency issues
</verification>

<success_criteria>
- ERROR-01 satisfied: Compilation errors are programmatically categorized by type
- ERROR-02 satisfied: Error patterns can be aggregated with percentage statistics
- Categorization logic is reusable across GUI, CLI, and test contexts
- Test coverage maintained (existing tests use new module, new tests added)
- Module follows existing validation package patterns (type hints, dataclasses, clean imports)
</success_criteria>

<output>
After completion, create `.planning/phases/04-error-analysis-system/04-01-SUMMARY.md`
</output>
