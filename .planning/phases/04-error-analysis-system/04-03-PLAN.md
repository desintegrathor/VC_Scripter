---
phase: 04-error-analysis-system
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - vcdecomp/gui/widgets/diff_viewer_widget.py
  - vcdecomp/validation/test_case_logger.py
  - vcdecomp/gui/views/error_analysis_view.py
autonomous: true

must_haves:
  truths:
    - "User can view side-by-side comparison of original assembly and decompiled C"
    - "Bytecode differences are highlighted at instruction level"
    - "Failed test cases are logged with reproducible steps"
    - "Logs include file paths, commands, and error summaries"
  artifacts:
    - path: "vcdecomp/gui/widgets/diff_viewer_widget.py"
      provides: "Side-by-side diff viewer for assembly vs C comparison"
      exports: ["DiffViewerWidget"]
      min_lines: 150
    - path: "vcdecomp/validation/test_case_logger.py"
      provides: "Test failure logging with reproducible steps"
      exports: ["log_failed_test_case"]
      min_lines: 80
    - path: "vcdecomp/gui/views/error_analysis_view.py"
      provides: "Integration of diff viewer"
      contains: "show_diff_for_error"
  key_links:
    - from: "vcdecomp/gui/widgets/diff_viewer_widget.py"
      to: "difflib"
      via: "import from stdlib"
      pattern: "from difflib import"
    - from: "vcdecomp/validation/test_case_logger.py"
      to: "ValidationResult"
      via: "function parameter"
      pattern: "def log_failed_test_case.*ValidationResult"
    - from: "vcdecomp/gui/views/error_analysis_view.py"
      to: "DiffViewerWidget"
      via: "widget composition"
      pattern: "self\\.diff_viewer = DiffViewerWidget"
---

<objective>
Create side-by-side comparison viewer and test failure logging for debugging decompiler issues.

Purpose: Satisfy ERROR-03, ERROR-04, and ERROR-05 requirements by providing visual diff comparison and reproducible debugging steps. Users can investigate why decompiled code differs from expected output and reproduce failures for iterative fixes.

Output: Diff viewer widget for assembly/C comparison with instruction-level highlighting, test case logger for markdown-formatted failure reports, integration with error analysis panel.
</objective>

<execution_context>
@C:\Users\flori\source\repos\VC_Scripter\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\flori\source\repos\VC_Scripter\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@C:\Users\flori\source\repos\VC_Scripter\.planning\PROJECT.md
@C:\Users\flori\source\repos\VC_Scripter\.planning\ROADMAP.md
@C:\Users\flori\source\repos\VC_Scripter\.planning\STATE.md
@C:\Users\flori\source\repos\VC_Scripter\.planning\phases\04-error-analysis-system\04-CONTEXT.md
@C:\Users\flori\source\repos\VC_Scripter\.planning\phases\04-error-analysis-system\04-RESEARCH.md

# Reference existing patterns
@C:\Users\flori\source\repos\VC_Scripter\vcdecomp\validation\bytecode_compare.py
@C:\Users\flori\source\repos\VC_Scripter\vcdecomp\gui\widgets\difference_widgets.py
</context>

<tasks>

<task type="auto">
  <name>Create DiffViewerWidget for side-by-side comparison</name>
  <files>vcdecomp/gui/widgets/diff_viewer_widget.py</files>
  <action>
Create vcdecomp/gui/widgets/diff_viewer_widget.py using difflib and PyQt6:

1. **Class structure:**
   - Inherit from QSplitter (horizontal split)
   - Two QTextEdit panes (left: original assembly, right: decompiled C)
   - Monospace font (Consolas 9pt) for alignment
   - Read-only text edits (view only, not editable)

2. **show_diff() method:**
   - Input: original_asm (str), decompiled_c (str)
   - Split into lines: original_lines = original_asm.splitlines()
   - Use difflib.unified_diff for instruction-level comparison
   - Highlight differences with background colors:
     - Lines only in original: light red (#ffe6e6)
     - Lines only in decompiled: light green (#e6ffe6)
     - Changed lines: light yellow (#fffacd)
     - Unchanged lines: white
   - Set left pane: original_asm with highlighting
   - Set right pane: decompiled_c with highlighting

3. **Highlighting implementation:**
   - Use QTextCharFormat and QTextCursor for rich text formatting
   - Pattern from RESEARCH.md Pattern 2 (difflib side-by-side)
   - Create helper method _apply_highlighting(text_edit, content, diff_info)
   - Apply background colors to specific line ranges

4. **show_bytecode_diff() method:**
   - Input: original_scr (Path), recompiled_scr (Path)
   - Use BytecodeComparator from vcdecomp.validation.bytecode_compare
   - Load comparison result with instruction-level differences
   - Format left pane: original bytecode disassembly
   - Format right pane: recompiled bytecode disassembly
   - Highlight differences at instruction level (per ERROR-04)
   - Use Difference objects to identify exact instruction offsets

5. **Empty state:**
   - If no diff loaded, show "No comparison loaded" placeholder

6. **Tab support (optional enhancement):**
   - Add QTabWidget to switch between:
     - Tab 1: Assembly vs C comparison
     - Tab 2: Bytecode instruction comparison
   - Allows viewing different comparison types in same widget

**Import dependencies:**
- from difflib import unified_diff, Differ
- from PyQt6.QtWidgets import QSplitter, QTextEdit, QTabWidget
- from PyQt6.QtCore import Qt
- from PyQt6.QtGui import QTextCharFormat, QTextCursor, QColor, QFont
- from vcdecomp.validation.bytecode_compare import BytecodeComparator
  </action>
  <verify>
python -c "from vcdecomp.gui.widgets.diff_viewer_widget import DiffViewerWidget; print('DiffViewerWidget imports successfully')"
  </verify>
  <done>
DiffViewerWidget class defined, show_diff method implemented, highlighting works, bytecode comparison integrated, follows Qt widget patterns
  </done>
</task>

<task type="auto">
  <name>Create test_case_logger module for reproducible failure logs</name>
  <files>vcdecomp/validation/test_case_logger.py</files>
  <action>
Create vcdecomp/validation/test_case_logger.py following RESEARCH.md Pattern for ERROR-05:

1. **log_failed_test_case() function:**
   - Input: result (ValidationResult), output_dir (Path)
   - Generate markdown file: {test_id}_failure.md
   - Markdown structure (per RESEARCH.md code example):
     - Header: # Test Failure: {test_id}
     - Metadata: Date, Verdict
     - Reproducible Steps section:
       - Step 1: Decompile command (python -m vcdecomp structure {original.scr})
       - Step 2: Compile command (scmp.exe {decompiled.c} {output.scr} {output.h})
     - Artifacts section:
       - Original .scr path
       - Decompiled .c path
       - Working directory (for .err files)
     - Error Summary section:
       - Categorized errors using categorize_compilation_errors
       - First 5 errors of each type
       - Group by error_type (syntax, semantic, type, include, other)

2. **Format markdown properly:**
   - Use ```bash for code blocks
   - Use bullet lists for artifacts and errors
   - Include timestamps (time.strftime('%Y-%m-%d %H:%M:%S'))
   - Preserve file paths as-is (absolute paths for reproducibility)

3. **Error categorization integration:**
   - Import categorize_compilation_errors from error_analyzer
   - Display error counts by category: "### Syntax Errors (15)"
   - Show first 5 examples of each type (limit verbosity)

4. **Handle edge cases:**
   - If output_dir doesn't exist, create it (output_dir.mkdir(parents=True, exist_ok=True))
   - If result has no errors, log verdict but note "No compilation errors" in summary
   - If compilation_result is None (decompilation failure), document that separately

**Module docstring:**
- Document purpose: "Generate reproducible test failure reports for debugging"
- Document output format: Markdown with commands, paths, error summaries
- Include usage example: log_failed_test_case(result, Path(".planning/test_failures"))

**Type hints:**
- from pathlib import Path
- from vcdecomp.validation.validation_types import ValidationResult
- Full type annotations on function signature
  </action>
  <verify>
python -c "from vcdecomp.validation.test_case_logger import log_failed_test_case; print('Logger imports successfully')"
  </verify>
  <done>
log_failed_test_case function defined, markdown generation works, error categorization integrated, reproducible steps formatted correctly
  </done>
</task>

<task type="auto">
  <name>Integrate DiffViewerWidget into ErrorAnalysisPanel</name>
  <files>vcdecomp/gui/views/error_analysis_view.py</files>
  <action>
Update vcdecomp/gui/views/error_analysis_view.py to add diff viewer:

1. **Add import:**
   - from vcdecomp.gui.widgets.diff_viewer_widget import DiffViewerWidget

2. **Update layout:**
   - Current layout: title + stats + error_tree + refresh button
   - New layout: Add QSplitter (vertical)
     - Top: error_tree
     - Bottom: diff_viewer (initially hidden or collapsed)
   - When user selects error in tree, show diff viewer

3. **Add show_diff_for_error() method:**
   - Input: CompilationError (from tree selection)
   - Determine original .scr path from validation result metadata
   - Load original .asm (disassembly of .scr)
   - Load decompiled .c (from validation result)
   - Call diff_viewer.show_diff(original_asm, decompiled_c)
   - Show diff viewer section (if hidden)

4. **Connect signal:**
   - Connect error_tree.error_selected to show_diff_for_error
   - When user clicks error in tree, diff viewer updates

5. **Add "Export Failure Log" button:**
   - Button text: "Export Failure Log"
   - On click: Use test_case_logger.log_failed_test_case()
   - Save to .planning/test_failures/{test_id}_failure.md
   - Show success message: "Failure log saved to {path}"
   - Use QFileDialog to let user choose output directory (default: .planning/test_failures)

**What to avoid:**
- Do NOT load diff automatically on panel load (wait for user selection)
- Do NOT auto-export logs (only on user button click)
- Do NOT modify existing error_tree or load_validation_results behavior
- Only add integration, no changes to core functionality
  </action>
  <verify>
python -c "from vcdecomp.gui.views.error_analysis_view import ErrorAnalysisPanel; print('Updated panel imports successfully')"
  </verify>
  <done>
DiffViewerWidget integrated into ErrorAnalysisPanel, show_diff_for_error method works, export button functional, signal connections established
  </done>
</task>

</tasks>

<verification>
1. GUI launches with error analysis panel: `python -m vcdecomp gui`
2. DiffViewerWidget displays placeholder when no diff loaded
3. test_case_logger generates valid markdown files
4. Export button creates failure log in .planning/test_failures/
5. Side-by-side comparison shows highlighted differences
</verification>

<success_criteria>
- ERROR-03 satisfied: Side-by-side view of assembly vs decompiled C with highlighting
- ERROR-04 satisfied: Bytecode differences highlighted at instruction level using BytecodeComparator
- ERROR-05 satisfied: Failed test cases logged with reproducible commands and error summaries
- Diff viewer integrates with error analysis panel
- Test case logger produces markdown files with clear reproduction steps
- Uses stdlib difflib (no new dependencies)
</success_criteria>

<output>
After completion, create `.planning/phases/04-error-analysis-system/04-03-SUMMARY.md`
</output>
