name: Decompilation Validation

on: [push, pull_request]

permissions:
  contents: read
  checks: write

jobs:
  validate:
    runs-on: [self-hosted, windows, x64]
    timeout-minutes: 30
    defaults:
      run:
        shell: cmd

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Python 3.13
      shell: cmd
      run: |
        set PATH=C:\Python313;C:\Python313\Scripts;%PATH%
        python --version

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r vcdecomp/requirements.txt

    - name: Run validation tests
      run: |
        python -m pytest vcdecomp/tests/test_validation.py -v --tb=short --junit-xml=test-results.xml --json-report --json-report-file=test-report.json
      continue-on-error: true

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-${{ github.run_number }}
        path: |
          test-results.xml
          test-report.json
        retention-days: 30

    - name: Publish test summary
      if: always()
      uses: EnricoMi/publish-unit-test-result-action/windows@v2
      with:
        files: test-results.xml
        check_name: Validation Test Results
